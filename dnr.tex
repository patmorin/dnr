\documentclass{patmorin}
\listfiles
\usepackage{pat}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{mathtools}
\usepackage{thmtools}
\usepackage{thm-restate}
% \usepackage{dingbat}
% \usepackage{todonotes}
% \usepackage{comment}

\usepackage[inline]{enumitem}
\usepackage{soul}
\usepackage[normalem]{ulem}

\newenvironment{dummy}{}
% david proposes the following additions
% \renewcommand{\ge}{\geqslant}
% \renewcommand{\le}{\leqslant}
% \renewcommand{\geq}{\geqslant}
% \renewcommand{\leq}{\leqslant}

\newcommand{\pat}[1]{\textcolor{Blue}{[Pat: #1]}}

% \numberwithin{equation}{lem}

\crefname{p}{}{}
\creflabelformat{p}{#2(#1)#3}

\usepackage{todonotes}
\newenvironment{clmproof}{\begin{proof}[Proof of Claim:]\renewcommand{\qedsymbol}{\rule{1ex}{1ex}}}{\end{proof}}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

% \newcommand{\mathdefin}[1]{\color{brightmaroon}#1}}
\setlength{\parskip}{1ex}

% Document-specific commands and math operators
\DeclareMathOperator{\len}{len}
\DeclareMathOperator{\sep}{sn}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\width}{width}
\DeclareMathOperator{\pw}{pw}
\DeclareMathOperator{\bw}{bw}
\DeclareMathOperator{\td}{td}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\height}{height}
\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\radius}{radius}
\DeclareMathOperator{\pth}{path}
\DeclareMathOperator{\mindist}{min-dist}
\DeclareMathOperator{\mindeg}{min-deg}
\DeclareMathOperator{\girth}{girth}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\ld}{ld}
\DeclareMathOperator{\polylog}{polylog}
\DeclareMathOperator{\evol}{Evol}
\DeclareMathOperator{\ivol}{Ivol}
\DeclareMathOperator{\tvol}{Tvol}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\GG}{\mathcal{G}}
\newcommand{\Oh}{\mathcal{O}}
\DeclareMathOperator{\thick}{th}

\DeclareMathOperator{\interior}{int}
\DeclareMathOperator{\boundary}{\partial}

\DeclarePairedDelimiter\set{\{}{\}}


\newcommand{\hussein}[1]{\textcolor{purple}{HH: #1}}

\title{\MakeUppercase{Dvo\v{r}Ã¡k-Norin Revisited}}
\title{\MakeUppercase{Separation Number and Treewidth, Revisited}}

\author{Hussein Houdrouge, Bobby Miraftab, and Pat Morin}

\date{}



\begin{document}

\maketitle

\begin{abstract}
  We give a constructive proof of the fact that the treewidth of a graph $G$ is bounded by a linear function of the separation number of $G$.
\end{abstract}


\section{Introduction}

In this paper every graph $G$ is undirected and simple with vertex set $V(G)$ and edge set $E(G)$.  A \defin{tree decomposition} of a graph $G$ is a collection $\mathcal{T}:=(B_x:x\in V(T))$ of vertex subsets of $G$, called \defin{bags}, that is indexed by the vertices of a tree $T$ and such that
\begin{enumerate*}[label=(\roman*)]
  \item\label{covers_edges} for each $vw\in E(G)$, there exists $x\in V(T)$ such that $\{v,w\}\subseteq B_x$; and
  \item\label{connectivity} for each vertex $v$ of $G$, $T[\{x\in V(T): v\in B_x]$ is a non-empty (connected) subtree of $T$.
\end{enumerate*}
The \defin{width}, of a tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ is $\mathdefin{\width(\mathcal{T})}:=\max\{|B_x|:x\in V(T)\}-1$. The \defin{treewidth} of a graph $G$ is $\mathdefin{\tw(G)}:=\min\{\width(\mathcal{T}):\text{$\mathcal{T}$ is a tree decomposition of $G$}\}$.

A \defin{separation} $(A,B)$ of a graph $G$ is a pair of subsets of $V(G)$ with $A\cup B= V(G)$ and such that, for each edge $vw$ of $G$, $\{v,w\}\subseteq A$ or $\{v,w\}\subseteq B$.  The \defin{order} of a separation $(A,B)$ is $|A\cap B|$.  A separation $(A,B)$ is \defin{balanced} if $|A\setminus B|\le \tfrac{2}{3}|V(G)|$ and $|B\setminus A|\le \tfrac{2}{3}|V(G)|$.  The \defin{separation number} $\mathdefin{\sep(G)}$ of a graph $G$ is the minimum integer $a$ such that every subgraph of $G$ has a balanced separation of order at most $a$.

A short argument due to \citet{robertson.seymour:graph} that has many generalizations shows that for any graph $G$, $\sep(G)\le \tw(G)+1$ .  We reprove the weak converse of this fact, first proven by \citet{dvorak.norin:treewidth}.
\begin{thm}\label{main_result}
  There exists a constant $c$ such that, for every graph $G$, $\tw(G)\le c\cdot \sep(G)$.
\end{thm}

Let $W$ be a subset of the vertices in a graph $G$.  A separation $(A,B)$ of $G$ is \defin{$W$-balanced} if $|(A\setminus B)\cap W|\le \tfrac{2}{3}|W|$ and $|(A\setminus B)\cap W|\le \tfrac{2}{3}|W|$.  If, for every subset $W\subseteq V(G)$, $G$ has a $W$-balanced separator of order $a$, then  $\tw(G)<4a$.  Indeed, a tree decomposition of $G$ can be constructed iteratively by an algorithm that maintains a separation $(X,Y)$ of order at most $3a$, and a tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $G[Y]$ of width less than $ca$ in which some bag $B_x$ contains all vertices in $W:=X\cap Y$.  To extend $\mathcal{T}$, the algorithm takes a $W$-balanced separation $(A,B)$ of $G[X]$ of order at most $a$ and creates a leaf $x'$ in $T$ adjacent to $x$ with $B_{x'}:=W\cup (A\cap B)$.\footnote{A $W$-balanced separation $(A,B)$ of $G[X]$ can be obtained from a $W$-balanced separation $(A',B')$ of $G$ by setting $(A,B):=(A'\cap X,B'\cap X)$.}  Note that $|B_{x'}|\le |W|+|A\cap B|\le 4a$, so the width of $\mathcal{T}$ is still less than $4a$. 
% This gives a tree decomposition of $G[Y']:=G[Y\cup (A\cap B)]$.
Let $X_A:=A$, $Y_A:=X\cup(A\cap B)$, $G_A:=G[X_A\cup Y_A]$ and $W_A:=X_A\cap Y_A$.  Then $\mathcal{T}$ is a tree decomposition $G[Y_A]$ of width less than $4a$ and $(X_A,Y_A)$ is a separation of $G_A$ of order $|W_A|\le|W\cap A|+|A\cap B|\le \tfrac{2}{3}|W|+a\le 3a$. The algorithm then inductively extends $\mathcal{T}$ to a tree decomposition of $G_A$.  Let $X_B:=B$, $Y_B:=X\cup A$, $G_B:=G$, and $W_B:=X_B\cap Y_B$.  Then $\mathcal{T}$ is a tree decomposition of $Y_B$ of width less than $4a$ and $(X_B,Y_B)$ is a separation of $G_B$ of order $|W_B|\le |W\cap B|+|A\cap B|\le\tfrac{2}{3}|W|+a\le 3a$.  The algorithm finishes by inductively extending $\mathcal{T}$ to a tree decomposition of $G_B=G$.

An efficient implementation of the algorithm discussed in the preceding paragraph is given by \citet[Fact~2.7]{reed:tree}.  The challenge in establishing \cref{main_result} is that the balanced separations in the definition of separation number are only able to balance the entire set of vertices in an arbitrary subgraph, rather than a specific subset $W$ of vertices.  In particular, there is no reason a balanced separation $(A,B)$ of $G[X]$ should have $|(A\setminus B)\cap W|<|W|$ and $|(B\setminus A)\cap W|<|W|$.

\citet{dvorak.norin:treewidth} prove \cref{main_result} with the constant $c=15$. Their proof is by contradiction and makes use of the relationship between treewidth and brambles established by \citet{seymour.thomas:graph}.  Essentially, they show that if $\tw(G)>15\sep(G)$, then there exists an $\alpha$-tame $W$-cloud (a special kind of network flow) which contradicts the choice of a haven (a special kind of flap assignment) that is derived from a bramble of order $15\sep(G)$.  The crux of their proof \cite[Proof of Lemma~7]{dvorak.norin:treewidth} involves showing that, for a \emph{carefully chosen} $W\subseteq V(G)$, a balanced separation of the subgraph induced by the saturated and hungry vertices of an $\alpha$-tame $W$-cloud is, by necessity, also balanced over the set $W$ of sinks in the $W$-cloud. This leads to a contradiction related to the choice of $W$.

In the current paper, we prove \cref{main_result} with the constant $c=\mathcolor{red}{48/(1-2\cdot(2/3)^5)+2< 66.1621}$.  Despite the larger constant, we believe that the proof given here has a number of advantages.  The proof is constructive: It proves that $\tw(G)\le c\cdot \sep(G)$ by constructing a tree decomposition of $G$ having width at most $c\cdot\sep(G)$.  The proof requires fewer definitions and previous results: It does not use brambles, havens, or network flows.  Brambles and havens are avoided entirely.  The use of network flows is replaced by a collection of paths obtained from repeated applications of the simplest version of Menger's Theorem on vertex-disjoint paths in (unweighted undirected) graphs.  

Most importantly, the proof given here is built around a generalization of $W$-balanced separations:  For a sufficiently large $t>0$ and an \emph{arbitrary} $W\subseteq V(G)$ of size at least $t\cdot \sep(G)$, there exists a subgraph $H$ of $G$ with $W\subseteq V(G)$ such that any balanced separation of $H$ must necessarily balance both $W$ and the set $Z:=N_G(V(G)\setminus V(H))$ of vertices that separate $V(G)\setminus V(H)$ from $W$. With this tool in hand, recursively taking balanced separations of subgraphs of $H$ gives an algorithm for constructing a tree decomposition of $G$ that is similar in spirit to the algorithm outlined above.

% The identification of the subgraph $H$ described above is related to what we consider the crux of the proof in \cite{dvorak.norin:treewidth}.  However, we define $H$ using repeated applications of Menger's Theorem, which increases the number of vertices in $H$ by $|W|$ at each step.  The closest thing to an equivalent notion in \cite{dvorak.norin:treewidth} is the graph $F$ that appears in the proof of Lemma~7. There, the graph $F$ is obtained by taking a special kind of network flow $f$ (an $\alpha$-tame $W$-cloud) in which the only sinks are the vertices in $W$ (for a \emph{carefully chosen} $W\subseteq V(G)$) and $F$ is defined to be the subgraph of $G$ induced by the (the hungry and saturated) vertices of $G$ that participate in $f$.

\section{Preliminaries}

For standard graph theoretic terminology and notations, see \citet{diestel2017graph}.
Let $G$ be a graph and let $S,T\subseteq V(G)$. An \defin{$S$-$T$ path} in $G$ is a path in $G$ whose first vertex is in $S$ and whose last vertex is in $T$.  We say that a set $Z\subseteq V(G)$ \defin{separates} $S$ and $T$ if $G-X$ has no $S$-$T$ path.  When $Z$ separates $S$ and $T$, any separation $(X,Y)$ of $G$ with $S\subseteq X$, $T\subseteq Y$ and $X\cap Y=Z$ is called an \defin{$(S,Z,T)$-separation}. To see that an $(S,Z,T)$-separation always exists, let $G_X$ be the union of all components of $G-Z$ that contain a vertex of $S$. Then $S\subseteq V(G_X)\cup Z$. Take $G_Y$ to be the union of all components of $G-Z$ not included in $G_X$. Since  every component of $G_X$ contains a vertex in $S$, no component of $G_X$ contains a vertex in $T$.  Therefore, $T\subseteq V(G_Y)\cup Z$.  Then the separation $(X,Y):=(V(G_X)\cup Z, V(G_Y)\cup Z)$ is an $(S,Z,T)$-separation.  

We make use of the following vertex connectivity version of Menger's Theorem (see, for example, \citet[Theorem~3.3.1]{diestel2017graph}): \
% \pat{We need a reference for this.}\hussein{I cited the graph theory book!}

\begin{thm}[Menger's Theorem]\label{menger}
  Let $G$ be a graph and let $S$ and $T$ be subsets of $V(G)$. For each $k\in\N$, exactly one of the following is true:
  \begin{enumerate}[nosep,nolistsep,label=\rm(\roman*),ref=(\roman*)2]
      \item $G$ contains $k$ pairwise vertex-disjoint $S$-$T$ paths; or
      \item $G$ has a vertex subset $Z$ of size less than $k$ that separates $S$ and $T$.
  \end{enumerate}
\end{thm}

The \defin{depth}, $\mathdefin{\depth_T(x)}$ of a node $x$ in a rooted tree $T$ is the number of edges on the path from $x$ to the root of $T$. The \defin{height} of a rooted tree $T$ is $\mathdefin{\height(T)}:=\max\{\depth_T(x):x\in V(T)\}$. For a node $x$ in a rooted tree $T$, we let $\mathdefin{T_x}$ denote the subtree of $T$ induced by all the descendants of $x$, including $x$ itself.
 
A tree decomposition $(B_x:x\in V(T))$ of a graph $G$ is \defin{rooted} if the tree $T$ is rooted.  Let $\mathcal{T}:=(B_x:x\in V(T))$ be a rooted tree decomposition of a graph $G$.    For the root $x_0$ of $T$, the \defin{boundary} of $x_0$ is $\mathdefin{\boundary_{\mathcal{T}}(x_0)}:=\emptyset$.  For a node $x$ of $T$ with parent $y$, the \defin{boundary} of $x$ is $\mathdefin{\boundary_\mathcal{T}(x)}:=B_x\cap B_y$.  The \defin{interior} of a node $x$ in $T$ is $\mathdefin{\interior_\mathcal{T}(x)}:=(\bigcup_{x'\in V(T_x)} B_{x'})\setminus \boundary(x)$.  Note that, for the root $x_0$ of $T$, $\interior_{\mathcal{T}}(x_0)=V(G)$.  From these definitions it follows that, if $T_y\supseteq T_x$, then $\interior_{\mathcal{T}}(x)\subseteq\interior_{\mathcal{T}}(y)$ and that $\interior_\mathcal{T}(x) \cup \boundary_\mathcal{T}(x)\subseteq \interior_\mathcal{T}(y) \cup \boundary_\mathcal{T}(y)$. In particular, these inclusion relations hold for every ancestor $y$ of $x$. 



% A \defin{separation tree} of a graph $G$ is a rooted ordered binary tree that either has no nodes, or in which the root node $r_0$ is a triple $(G,A,B)$ where $(A,B)$ is a separation of $G$, the left child of $r_0$ is the root of a separation tree of $G[A]$ and the right child of $r_0$ is the root of a separation tree of $G[B]$. (If left or right child of $r_0$ is the tree with no nodes, then we treat $r_0$ as having no left or right child, respectively.)


% Let $T$ be a separation tree of $G$ and let $r_0,\ldots,r_d$ be the path in $T$ from the root node $r_0$ to some node $r_d$ of depth $d$, and let $r_i:=(G_i,A_i,B_i)$ for each $i\in\{0,\ldots,d\}$.
% For each $i\in\{0,\ldots,d-1\}$, let
% \[
%   (C_i,\overline{C}_i):=
%   \begin{cases}
%     (A_i,B_i) & \text{if $r_{i+1}$ is the left child of $r_{i}$} \\
%     (B_i,A_i) & \text{if $r_{i+1}$ is the right child of $r_{i}$.}
%   \end{cases}
% \]
% From these definitions, it follows that $G_p := G[\bigcap_{i=0}^{p-1} C_i]$.
% We define the \defin{boundary} of $r_d$ as $\mathdefin{\boundary(r_d)}:=V(G_d)\cap(\bigcup_{i=0}^{d-1}(A_i\cap B_i))$ and the \defin{interior} of $r_d$ as $\mathdefin{\interior(r_d)}:=V(G_d) \setminus \boundary(r_d)$. These definition imply the following:
% \begin{enumerate}[nosep,nolistsep,label=(T\arabic*)]
%   \item $N_G(\interior(r_d))=\boundary(r_d)$;
%   \item\label{small_boundary} $N_G(\interior(r_d))\subseteq \bigcup_{i=0}^{d-1}(A_i\cap B_i)$; and
%   \item\label{small_interior} $\interior(r_d) = \bigcap_{i=0}^{d-1}(C_i\setminus\overline{C}_i)$.
% \end{enumerate}

% it follows that the boundary of $r_d$ is exactly the set of vertices of $G$ incident to some vertex in $\interior(r_d)$.  That is, $N_G(\interior(r_d))=\boundary(r_d)$.  In particular,
% $N_G(\interior(r_d))$ is contained in $\bigcup_{i=0}^{d-1}(A_i\cap B_i)$.

The following lemma allows us to restrict a rooted tree decomposition of a graph $G$ to the subgraph $G[Y]$ induced by one part of a separation $(X,Y)$ in such a way that $X\cap Y$ is contained in a single bag (the root bag) of the resulting decomposition.

\begin{lem}\label{restricted_decomp}
    Let $\mathcal{T}':=(B'_x:x\in V(T'))$ be a rooted tree decomposition of a graph $G$, let $(X,Y)$ be a separation of $G$, and let $B_x:=(B'_x\cap Y)\cup (\interior_{\mathcal{T}'}(x) \cap X \cap Y)$ for each $x\in V(T')$.  Then $\mathcal{T}:=(B_x:x\in V(T'))$ is a tree decomposition of $G[Y]$. 
\end{lem}

\begin{proof}
  Let $vw$ be an edge of $G[Y]$.  Since $vw$ is also an edge of $G$ and  $\mathcal{T'}$ is a tree decomposition of $G$,  $\{v,w\}\subseteq B'_x$ for some $x\in V(T')$, so $\{v,w\}\subseteq B'_x\cap Y\subseteq  B_x$. Thus, $\mathcal{T}$ has Property~\ref{covers_edges} of tree decompositions.  
  % We now argue that $\mathcal{T}$ also has Property~\ref{connectivity} of tree decompositions.

  \pat{There should be a shorter proof that $\mathcal{T}$ satisfies Property~\ref{connectivity}.}
  Suppose, for the sake of contradiction, that $\mathcal{T}$ violates Property~\ref{connectivity}.  Then there exists some $v\in Y$, some $r\ge 2$, and some path $P=x_0,\ldots,x_r$ in $T'$ with $v\in B_{x_0}$, $v\in B_{x_r}$ and $v\not\in B_{x_i}$ for some $i\in\{1,\ldots,r-1\}$.  Let $P$ be chosen so that its length, $r$, is minimum.  Then $v\not\in B_{x_i}$ for each $i\in\{1,\ldots,r-1\}$. 
  
  Since $\mathcal{T}'$ is a tree decomposition of $G$, $v\not\in B'_{x_0}$ or $v\not\in B'_{x_r}$ since, otherwise $v\in B_{x_i}\subseteq B'_{x_i}\cap Y$ for each $i\in\{0,\ldots,r\}$.  Assume, without loss of generality that $v\not\in B'_{x_r}$. Therefore $v\in\interior_{\mathcal{T}'}(x_r)\cap X\cap Y$.  In particular, $v\in X\cap Y$.
  
  Define $i^*$ so that $x_{i^*}$ is the uniqe vertex in $P$ that is ancestor of both $x_0$ and $x_r$.  Then  $\interior_{\mathcal{T}'}(x_{i^*})\supseteq \interior_{\mathcal{T}'}(x_i)$ for each $i\in\{0,\ldots,r\}$.  In particular $v\in \interior_{\mathcal{T}'}(x_r)\cap X\cap Y\subseteq\interior_{\mathcal{T}'}(x_{i^*})\cap X\cap Y\subseteq B_{x_{i}}$ for each $i\in\{i^*,\ldots,r\}$.  Therefore $i^*=r$ and $x_r$ is an ancestor of $x_0$. Furthermore, $v\not\in\interior_{\mathcal{T}'}(x_0)$ since, otherwise $v\in\interior_{\mathcal{T}'}(x_1)\cap X\cap Y\subseteq B_{x_1}$. Therefore $v\in B'_{x_0}$.  Thus $x_1$ is the parent of $x_0$, $v\in B'_{x_0}$ and $v\not\in (B'_{x_1}\cap Y)\cup (\interior_{\mathcal{T}'}(x_1)\cap X\cap Y)
  \supseteq (B'_{x_i}\cup \interior_{\mathcal{T}'}(x_1))\cap\{v\}
  \supseteq (\boundary_{\mathcal{T}'}(x_1)\cup \interior_{\mathcal{T}'}(x_1))\cap\{v\} \supseteq (\boundary_{\mathcal{T}'}(x_0)\cup \interior_{\mathcal{T}'}(x_0))\cap \{v\} \supseteq B'_{x_0}\cap\{v\}$. This contradicts the fact that $v\in B'_{x_0}$.
\end{proof}


The following construction of a tree decomposition using balanced separations (or variants of this construction using balanced separators) is fairly standard.

\begin{lem}\label{separation_tree}
  Let $G$ be an $n$-vertex graph with $\sep(G)\le a$.  Then, for every integer $h\ge 0$, $G$ has a rooted tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ such that
  \begin{enumerate}[nosep,nolistsep,label=(\roman*)]
    \item\label{height_bound} $\height(T)\le h$;
    \item\label{size_bounds} for each $x\in V(T)$,  $|\interior_\mathcal{T}(x)|\le n\cdot(\tfrac{2}{3})^{\depth_T(x)}$ and $|\boundary(x)|\le \depth_T(x)\cdot a$;
    \item\label{leaf_size_bounds} for each leaf $y$ of $T$, $|\interior_{\mathcal{T}}(y)|\le n\cdot(\tfrac{2}{3})^h$.
  \end{enumerate}
\end{lem}

% \hussein{I think you mean there exists $h$ instead of for every $d$.} \pat{Yes! Fixed.}
% \begin{lem}\label{separation_tree}
%   % \pat{Be a little more careful. The empty tree satisfies this definition.}
%   Let $G$ be an $n$-vertex graph with $\sep(G)\le a$.  Then, for every $h\ge 0$, $G$ has a separation tree $T$ of height at most $h$ such that, for each $d\in\{0,\ldots,h\}$ and for each node $x\in V(T)$ of depth $d$, $|V(\interior(x))|\le n\cdot (\tfrac{2}{3})^d$ and $|\boundary(x)|\le da$. 
  
%   Furthermore, for each node $x:=(G',A',B')$ of $T$ that has no left child, $|\interior(x)\setminus B|< n\cdot (\tfrac{2}{3})^{h}$.  For each node $x$ of $T$ that has no right child, $|\interior(x)\setminus A|< n\cdot (\tfrac{2}{3})^h$.
% \end{lem}

\begin{proof}
  The tree decomposition $\mathcal{T}=(B_x:x\in V(T))$ and its supporting tree $T$ is constructed recursively, as follows:  Fix a global value $N:=n\cdot(\tfrac{2}{3})^h$ that does not change during recursive invocations. Each recursive invocation takes a pair $(G',\partial')$ and the initial invocation is on the pair $(G,\emptyset)$. When recursing on $(G',\partial')$ to construct a subtree $T'$ we apply the following rule:  If $|V(G')\setminus\partial'|\le N$, then $T'$ consists of a single node $x$ with $B_{x}:=V(G')$.  Otherwise, let $(A',B')$ be a balanced separation of $G'-\partial'$ of order at most $a$.  The root $x$ of $T'$ has $B_{x}:=\partial'\cup (A'\cap B')$. The left child of $x$ is the root of the tree obtained by recursing on $(G'[A'],A'\cap(\partial'\cup B'))$ and the right child of $x$ is the root of the tree obtained by recursing on $(G[B'],B'\cap(\partial'\cup A'))$.

  We now show that $\boundary_{\mathcal{T}}(x)=\partial_x$, for each subtree $T_x$ rooted at $x\in V(T)$ that was constructed by a recursive invocation on $(G_x,\partial_x)$. If $\depth_T(x)=0$ then $x$ is the root of $T$ and $\boundary_{\mathcal{T}}(x)=\emptyset=\partial_x$, by definition.  
  Now suppose $\depth_T(x)\ge 1$, the parent of $x$ is $y$ and $T_y$ is the result of a recursive invocation on $(G_y,\partial_y)$.
  % By the inductive hypothesis $\partial_y=\boundary_{\mathcal{T}}(y))$.
  Without loss of generality, $G_x=G[A^y]$ where $(A^y,B^y)$ is a separation of $G_y-\partial_y$.  Then $\partial_x=(A^y\cap(\partial_y\cup B^y)=(A^y\cap (\partial_y\cup (A^y\cap B^y))=A^y\cap B_y$.  If $x$ is a leaf of $T$ then $B_x=V(G_x)=A^y$, so $B_x\cap B_y=A^y\cap B_y=\partial_x$.  If $x$ is not a leaf of $T$ then $B_x=\partial_x\cup (A^x\cap B^x)$ where $(A^x,B^x)$ is a separation of $G_x-\partial_x=G[A^y\setminus (A^y\cap B_y)]=G[A^y\setminus B_y]$. In particular, $A^x\cup B^x$ contain no vertex of $B_y$, so $B_x\cap B_y=(\partial_x\cup (A^x\cap B^x))\cap B_y= \partial_x\cap B_y=\partial_x$ since $\partial_x=A^y\cap B_y\subseteq B_y$.  In either case $\boundary_{\mathcal{T}}(x)=B_x\cap B_y=\partial_x$.
  
  % \boundary(x)=B_x\cap B_y=B_x\cap\boundary(y)$  
  
  Now the bounds on $|\interior_{\mathcal{T}}(x)|$ and $|\boundary_{\mathcal{T}}(x)|$ are easily established by induction on $d:=\depth_T(x)$: When $d=0$, $|\boundary_{\mathcal{T}}(x)|=|\emptyset|=0 = 0a$ and $|\interior_{\mathcal{T}}(x)|=|V(G)\setminus\boundary_{\mathcal{T}}(x)|=n=n\cdot (\tfrac{2}{3})^0$. Now consider a node $x$ of depth $d\ge 1$ with parent $y$ that was created by a recursive invocation on $(G_y,\partial_y)=(G_y,\boundary_\mathcal{T}(y))$. Without loss of generality $T_x$ was created by a recursive invocation on $(G[A^y],\partial_x)$ where $(A^y,B^y)$ is a balanced separation of $G_y-\boundary_y=\interior_{\mathcal{T}}(y)$. Then  $|\interior_{\mathcal{T}}(x)|\le \tfrac{2}{3}\cdot |\interior_{\mathcal{T}}(y)|\le \tfrac{2}{3}\cdot (\frac{2}{3})^{d-1}\cdot n=(\tfrac{2}{3})^d\cdot n$ and $|\boundary_{\mathcal{T}}(x)|=|\partial_x|\le |\partial_y|+|A^y\cap B^y|= |\boundary_{\mathcal{T}}(y)|+|A^y\cap B^y|\le (d-1)a + a=da$.
  
  The bound on $\height(T)$ follows from the bound $|\interior_{\mathcal{T}}(x)|\le n\cdot (\tfrac{2}{3})^{\depth_T(x)}$ and the fact that the algorithm returns a 1-node tree (of height $0$) when $|V(G')\setminus\partial|\le N=n\cdot(\tfrac{2}{3})^h$.
\end{proof}






% When dealing with small graphs, we make use of the following easy lemma \pat{needs a reference}:

% This lemma is no longer needed.
% \begin{lem}\label{small_size}
%   Let $G$ be an $n$-vertex graph with $\sep(G)\le a$.  Then $\tw(G)< \max\{a,a(1+\log_{3/2}(n/a))\}$.
% \end{lem}

% \begin{proof}
%   The proof is by induction on $n$. If $n \le a$ then $\tw(G)< n\le a$.  Now assume $n> a$. Let $(A,B)$ be a balanced separation of $G$ of order at most $a$.  If $|A\setminus B|\le a$, then $\tw(G[A\setminus B])<a$.  If $|A\setminus B|> a$ then, by induction,
%   \begin{align*}
%     \tw(G[A\setminus B])
%     & < \max\{a,a(1+\log_{3/2}(|A\setminus B|/a))\} \\
%     & = a(1+\log_{3/2}(|A\setminus B|/a)) \\
%     & \le a(1+\log_{3/2}(2n/3a)) \\
%     & = a\log_{3/2}(n/a) \enspace .
%   \end{align*}
%   By a symmetric argument, $\tw(G[B\setminus A])< a\log_{3/2}(n/a)$.  Let $(B_x:x\in V(T_A))$ be a minimum-width tree decomposition of $G[A\setminus B]$ and let $(B_x:x\in V(T_B))$ be a minimum-width tree decomposition of $G[B\setminus A]$.  Let $T$ be the tree obtained by creating a new node $y$ adjacent some node of $T_A$ and some node of $T_B$.  Let $C_y:=A\cap B$ and, for each node $x\in V(T_A)\cup V(T_B)$ let $C_x:=B_x\cup (A\cap B)$.  Then $(C_x:x\in V(T))$ is a tree decomposition of $G$ whose width is at most
%   \[
%     \max\{\tw(G[B\setminus A]),\tw(G[A\setminus B])\}+a
%     \le (a+1)\log_{3/2}(n/a) \enspace . \qedhere
%   \]
% \end{proof}


\section{The Proof}

% \pat{In hindsight, the definition of $W$-sequence should have sets $W_0,\ldots,W_{\ell}$.  This would make many of the formulas cleaner.}

The following definition replaces the notion of $W$-clouds in \cite{dvorak.norin:treewidth}.
Let $W_{-1}:=\emptyset$, let $G$ be a graph, let $W\subseteq V(G)$, let $W_0\subseteq W_1\subseteq\cdots\subseteq W_{\ell}\subseteq W_{\ell+1}\subseteq V(G)$ be a nested sequence of vertex subsets of $G$, and let $\Delta_i:=W_{i}\setminus W_{i-1}$ and $s_i:=|\Delta_i|$, for each $i\in\{0,\ldots,\ell+1\}$.  Then $W_0,\ldots,W_{\ell+1}$ is a \defin{$W$-sequence of width $w$} in $G$ if it satisfies the following conditions:
\begin{enumerate}[nosep,nolistsep,label=\rm(\alph*),ref=(\alph*)]
  \item $W_0=W$.\label{w_starts}
  \item $s_i=w$, for each $i\in\{0,\ldots,\ell\}$.\label{uniform_size}
  \item $s_{\ell+1}\in\{0,\ldots,w-1\}$.\label{remainder}
  \item $G[W_i]$ contains $s_i$  pairwise vertex-disjoint $\Delta_i$-$W$ paths, for each $i\in\{0,\ldots,\ell+1\}$.\label{linked}
  \item There exists $Z\subseteq W_{\ell+1}$ with $|Z|=s_{\ell+1}$ that separates $V(G)\setminus W_{\ell}$ and $W$. \label{separated}
\end{enumerate}



% \hussein{In this lemma, if we consumed all the vertices of $G$ by appending each time a $|W|$ vertices, then $s_{\ell + 1} = |W| \geq w$, contradicting $d$!}  
% \pat{No, then we just have $s_{\ell+1}=0$.  I've changed \ref{remainder} to make it clear that this is a possibility.}
\begin{lem}\label{w_sequence}
  For every graph $G$, every $W\subseteq V(G)$ and every non-negative integer $w\le |W|$, there exists a $W$-sequence of width $w$ in $G$.
\end{lem}

\begin{proof}
  Let $W_0:=W$ and suppose that sets $W_0,\ldots,W_{i}$ have been defined that satisfy \ref{w_starts}, \ref{uniform_size} and \ref{linked} for some $i\ge 0$.  (These conditions are trivially satisfied for $i=0$.)  We now show how to construct $W_{i+1}$.

  Let $w'$ be the maximum number of pairwise vertex-disjoint $(V(G)\setminus W_i)$-$W$ paths in $G$, let $r:=\min\{w,w'\}$, and let $P_1,\ldots,P_{r}$ be pairwise vertex-disjoint $(V(G)\setminus W_i)$-$W$ paths in $G$.  For each $j\in\{1,\ldots,r\}$ let $v_j$ be the last vertex of $P_j$ contained in $V(G)\setminus W_i$ and let $P_j'$ be the subpath of $P_j$ that begins at $v_j$ and ends at the first vertex of $P_j$ contained in $W$.  Set $W_{i+1}:=\{v_1,\ldots,v_r\}\cup W_i$, which implies that $s_{i+1}=r$.  The paths $P_1',\ldots,P_{s_{i+1}}'$ certify that $W_0,\ldots,W_{i+1}$ satisfies \ref{linked}.

  If $r=w$ then $W_{i+1}$ also satisfies \ref{uniform_size} so that we now a sequence $W_0,\ldots,W_{i+1}$ that satisfies \ref{w_starts}, \ref{uniform_size} and \ref{linked}.  In this case we can continue to define $W_{i+2}$ as above.

  If $r< w$ then we set $\ell:=i$. Since $r< w$, $s_{\ell+1}=r<w$, so this choice of $\ell$ satisfies \ref{remainder}.  Since $G$ does not contain $k:=r+1$ pairwise vertex-disjoint $(V(G)\setminus W_{i})$-$W$ paths, \cref{menger} implies that there exists $Z\subseteq V(G)$ with $|Z|\le r$ such that $G-Z$ has no $(V(G)\setminus W_{\ell})$-$W$ path.  Since the paths $P_1',\ldots,P_{r}'$ are pairwise vertex-disjoint  $(V(G)\setminus W_{\ell})$-$W$ paths, $Z$ must contain at least one vertex from each of these paths, so $|Z|\ge r$. Therefore, $r\le |Z|\le r$, so $|Z|=r=s_{\ell+1}$.  Since $V(P_j')\subseteq W_{\ell+1}$ for each $j\in\{1,\ldots,s_{\ell+1}\}$, $Z\subseteq W_{\ell+1}$.  Therefore, this choice of $Z$ satisfies \ref{separated}.  Therefore, the sequence $W_0,\ldots,W_{\ell+1}$ satisfies \ref{w_starts} (a condition on $W_0$), \ref{uniform_size} (conditions on $W_1,\ldots,W_{\ell}$), \ref{remainder} (a condition $W_{\ell+1}$), \ref{linked} (conditions on $W_0,\ldots,W_{\ell+1}$), and \ref{separated} (a condition on $W_{\ell+1}$).  Thus, $W_0,\ldots,W_{\ell+1}$ is a $W$-sequence of width $w$ in $G$.
\end{proof}

% One should think of $W$ as the contents of a bag in a partially constructed tree decomposition of some larger graph $G^+$.  That is $W=V(G)\cap H$ where $(V(G),H)$ is a separation of $G^+$, we have already constructed a tree decomposition of $G^+[H]$, and some bag of this decomposition includes all the vertices in $W$.  The purpose of $W$-sequences is to find a separator $S$ that splits $G$ in such a way that each component of $G-(W\cup S)$ is incident to at most $|W|$ vertices in $W\cup S$.  We will use the next two lemmas construct a separator $S:=Z\cup S_1\cup\cdots\cup S_p$ where $S_i$ is a balanced separator of (some subgraph of) $G[W_{\ell+1}]$, for each $i\in\{1,\ldots,p\}$.


% \begin{lem}\label{uniform_balance}
%   Let $G$ be a graph and let $W_0,\ldots,W_{\ell},W_{\ell+1}$ be a $W$-sequence of width $|W|$ in $G$, for some $W\subseteq V(G)$. Let $(A,B)$ be a separation of $G[W_{\ell+1}]$. Then
%   \[
%      |(A\setminus B)\cap W| \le \frac{|A\setminus B|\mathcolor{red}{{}+|\mathcal{P}^{B,A}|}}{\ell+1} + |A\cap B|
%   \]
% \end{lem}

% \begin{proof}
%   Let $\Delta_0,\ldots,\Delta_{\ell+1}$ and $s_0,\ldots,s_{\ell+1}$ be as in the definition of $W$-sequence.
%   We will lower bound the number of vertices in $B\cap W$, which is sufficient, since $|(A\setminus B)\cap W|=|W|-|B\cap W|$.  For each $j\in\{0,\ldots,\ell+1\}$, let $B_j:=B\cap \Delta_j$ and let $\mathcal{P}_j$ be a set of $|B_j|$ pairwise vertex-disjoint $B_j$-$W$ paths in $G[W_j]$, each of which contains exactly one vertex in $W$.  (The existence of $|B_j|$ such paths is part of the definition of $W$-sequence.)

%   Each path in $\mathcal{P}_0$ consists of a single vertex in $W$, which is also in $B$.
%   For $j\in\{1,\ldots,\ell+1\}$, since the paths in $\mathcal{P}_j$ are pairwise vertex-disjoint, at most $|A\cap B|$ of the paths in $\mathcal{P}_j$ contain a vertex of $A\cap B$.  Therefore, $\mathcal{P}_j$ contains a subset $\mathcal{P}_j'$ of size at least $|\mathcal{P}_j|-|A\cap B|$ made up of paths that are contained in $G[B\setminus A]$.  Let $\mathcal{P}:=\mathcal{P}_0\cup \bigcup_{j=1}^{\ell+1} \mathcal{P}_j'$. Then,
%   \[
%     |\mathcal{P}|=|\mathcal{P}_0|+\sum_{j=1}^{\ell+1}|\mathcal{P}_j'| \ge \sum_{j=0}^{\ell+1}|\mathcal{P}_j| - (\ell+1)\cdot|A\cap B|
%     = |B|-(\ell+1)\cdot|A\cap B| \enspace .
%   \]
%   Each path in $\mathcal{P}$ ends at a vertex in $B\cap W$.  A vertex $w\in B\cap W$ is \defin{full} if $w$ is the endpoint of $\ell+2$ paths in $\mathcal{P}$.  If $w$ is full, then $w$ is the endpoint of exactly one path in $\mathcal{P}'_j$ for each $j\in\{1,\ldots,\ell+1\}$ (and $w$ is the unique vertex of a path in $\mathcal{P}_0$).  Let $f$ be the number of full vertices in $W\cap B$.  Since each full vertex is the endpoint of a path in $\mathcal{P}'_{\ell+1}$, $f\le |\mathcal{P}'_{\ell+1}|\le s_{\ell+1}$.  The full vertices of $W\cap B$ are the endpoints of $f\cdot (\ell+2)$ paths in $\mathcal{P}$. Therefore,  $|\mathcal{P}|-f\cdot(\ell+2)$ paths in $\mathcal{P}$ end at non-full vertices $W\cap B$.
%   % Therefore, $W\cap B$ contains at most $s_{\ell+1}\cdot (\ell+2)/s_{\ell+1}=(\ell+2)/(\ell+1)$ full vertices.
%   Each of the $|B\cap W|-f$ non-full vertex of $W\cap B$ is an endpoint of at most $\ell+1$ paths in $\mathcal{P}$.  Therefore,
%   \begin{align*}
%      |B\cap W|
%      & = f+(|B\cap W|-f) \\
%      & \ge 
%      % \frac{s_{\ell+1}\cdot (\ell+2)}{\ell+2} 
%      f
%      + \frac{|\mathcal{P}|-f\cdot(\ell+2)}{\ell+1} \\
%      & =\frac{|\mathcal{P}|}{\ell+1} - \frac{f}{\ell+1} \\
%      & \ge\frac{|\mathcal{P}|}{\ell+1} - \frac{s_{\ell+1}}{\ell+1} \\
%      % s_{\ell+1}
%      % + \frac{|\mathcal{P}|-s_{\ell+1}\cdot(\ell+2)}{\ell+1} \\
%      % & = s_{\ell+1} + \frac{|\mathcal{P}|}{\ell+1}-\frac{s_{\ell+1}\cdot(\ell+2)}{\ell+1} \\
%      % & = s_{\ell+1} + \frac{|\mathcal{P}|}{\ell+1}-s_{\ell+1}
%      % - \frac{s_{\ell+1}}{\ell+1}\\
%      % & = \frac{|\mathcal{P}|}{\ell+1}
%      % - \frac{s_{\ell+1}}{\ell+1}\\
%      & \ge \frac{|B|-(\ell+1)\cdot|A\cap B|}{\ell+1}
%      - \frac{s_{\ell+1}}{\ell+1}\\
%      & = \frac{|W_{\ell+1}|-|A\setminus B|}{\ell+1}
%      - \frac{s_{\ell+1}}{\ell+1} - |A\cap B|\\
%      & = \frac{s_{\ell+1}+(\ell+1)\cdot|W|-|A\setminus B|}{\ell+1}
%      - \frac{s_{\ell+1}}{\ell+1} - |A\cap B|\\
%      % & = \frac{(\ell+1)\cdot|W|-|S|-(\ell+2)\cdot|A\cap B|}{\ell+1} \\
%      & = |W|-\frac{|A\setminus B|}{\ell+1}-|A\cap B| \enspace .
%   \end{align*}
% \hussein{It seems to me that we are counted the paths that goes to the full vertices inside $P$ as well, then we remove them. I don't know if we can be a little bit efficient!} \pat{I thought that for a moment, too, but now I don't.  We count the number of full vertices $f$ and the number of non-full vertices $|W\cap B|-f$.}\hussein{Ok, I will read it again, I got distracted with students.}

%   Therefore,
%   \[
%     |(A\setminus B)\cap W|=|W|-|B\cap W|\le \frac{|A\setminus B|}{\ell+1}+ |A\cap B| \enspace . \qedhere
%   \]
% \end{proof}

% \pat{Reworking:}

% \begin{lem}\label{uniform_balance}
%   Let $G$ be a graph, let $W\subseteq V(G)$, let $W_0,\ldots,W_{\ell},W_{\ell+1}$ be a $W$-sequence of width $|W|$ in $G$, and let $\Delta_{\ell+1}:=W_{\ell+1}\setminus W_{\ell}$. Then
%   \[
%      |W\setminus B| \le \frac{|A\setminus B|-|\Delta_{\ell+1}\setminus B|}{\ell+1} + |A\cap B|
%   \]
% \end{lem}

% \begin{proof}
%   Let $\Delta_{0},\ldots,\Delta_\ell$ be as in the definition of $W$-sequence.
%   For each $i\in\{0,\ldots,\ell\}$, $G[W_{i}]$ contains a set $\mathcal{P}_i$ of $|W\setminus B|$ pairwise vertex-disjoint $\Delta_i$-$(W\setminus B)$ paths.  For each $i\in\{0,\ldots,\ell\}$, let $\mathcal{P}'_i\subseteq \mathcal{P}_i$ contain the paths in $\mathcal{P}_i$ that begin at a vertex in $A\setminus B$ and let $\overline{\mathcal{P}}'_i:=\mathcal{P}_i\setminus \mathcal{P}'_i$.  At most $|A\cap B|$ of the paths in $\mathcal{P}_i$ contain a vertex of $A\cap B$.  Since $(A,B)$ is a separation of $G[W_{\ell+1}]$, this implies that $|\overline{\mathcal{P}}'_i|\le |A\cap B|$.
  
%   Each vertex of $W\setminus B$ is the last vertex of exactly one path in $\mathcal{P}_i$, for each $i\in\{0,\ldots,\ell\}$.  Since $\Delta_0,\ldots,\Delta_{\ell+1}$ are a partition of $W_{\ell+1}$, we have:
%   \begin{align*}
%     |W\setminus B|
%       % & \le \frac{1}{\ell+1}\cdot\sum_{i=0}^{\ell}\left(|\Delta_i\setminus B|+|\Delta_i\cap B|\right) \\
%       & \le \frac{1}{\ell+1}\cdot\sum_{i=0}^{\ell}\left(|\mathcal{P}_i'|+|\overline{\mathcal{P}}_i'|\right) \\
%       & \le \frac{1}{\ell+1}\cdot\sum_{i=0}^{\ell}\left(|\Delta_i\setminus B|+|A\cap B|\right) \\
%       & = \frac{|W_\ell\setminus B|}{\ell+1} + |A\cap B| \\
%       & = \frac{|A\setminus B|-|\Delta_{\ell+1}\setminus B|}{\ell+1} + |A\cap B| \enspace . \qedhere
%   \end{align*}
% \end{proof}
  
  
% %   pairwise disjoint


% %   Let $\Delta_0,\ldots,\Delta_{\ell+1}$ and $s_0,\ldots,s_{\ell+1}$ be as in the definition of $W$-sequence.
% %   We will lower bound the number of vertices in $B\cap W$, which is sufficient, since $|(A\setminus B)\cap W|=|W|-|B\cap W|$.  For each $j\in\{0,\ldots,\ell+1\}$, let $B_j:=B\cap \Delta_j$ and let $\mathcal{P}_j$ be a set of $|B_j|$ pairwise vertex-disjoint $B_j$-$W$ paths in $G[W_j]$, each of which contains exactly one vertex in $W$.  (The existence of $|B_j|$ such paths is part of the definition of $W$-sequence.)

% %   Each path in $\mathcal{P}_0$ consists of a single vertex in $W$, which is also in $B$.
% %   For $j\in\{1,\ldots,\ell+1\}$, since the paths in $\mathcal{P}_j$ are pairwise vertex-disjoint, at most $|A\cap B|$ of the paths in $\mathcal{P}_j$ contain a vertex of $A\cap B$.  Therefore, $\mathcal{P}_j$ contains a subset $\mathcal{P}_j'$ of size at least $|\mathcal{P}_j|-|A\cap B|$ made up of paths that are contained in $G[B\setminus A]$.  Let $\mathcal{P}:=\mathcal{P}_0\cup \bigcup_{j=1}^{\ell+1} \mathcal{P}_j'$. Then,
% %   \[
% %     |\mathcal{P}|=|\mathcal{P}_0|+\sum_{j=1}^{\ell+1}|\mathcal{P}_j'| \ge \sum_{j=0}^{\ell+1}|\mathcal{P}_j| - (\ell+1)\cdot|A\cap B|
% %     = |B|-(\ell+1)\cdot|A\cap B| \enspace .
% %   \]
% %   Each path in $\mathcal{P}$ ends at a vertex in $B\cap W$.  A vertex $w\in B\cap W$ is \defin{full} if $w$ is the endpoint of $\ell+2$ paths in $\mathcal{P}$.  If $w$ is full, then $w$ is the endpoint of exactly one path in $\mathcal{P}'_j$ for each $j\in\{1,\ldots,\ell+1\}$ (and $w$ is the unique vertex of a path in $\mathcal{P}_0$).  Let $f$ be the number of full vertices in $W\cap B$.  Since each full vertex is the endpoint of a path in $\mathcal{P}'_{\ell+1}$, $f\le |\mathcal{P}'_{\ell+1}|\le s_{\ell+1}$.  The full vertices of $W\cap B$ are the endpoints of $f\cdot (\ell+2)$ paths in $\mathcal{P}$. Therefore,  $|\mathcal{P}|-f\cdot(\ell+2)$ paths in $\mathcal{P}$ end at non-full vertices $W\cap B$.
% %   % Therefore, $W\cap B$ contains at most $s_{\ell+1}\cdot (\ell+2)/s_{\ell+1}=(\ell+2)/(\ell+1)$ full vertices.
% %   Each of the $|B\cap W|-f$ non-full vertex of $W\cap B$ is an endpoint of at most $\ell+1$ paths in $\mathcal{P}$.  Therefore,
% %   \begin{align*}
% %      |B\cap W|
% %      & = f+(|B\cap W|-f) \\
% %      & \ge 
% %      % \frac{s_{\ell+1}\cdot (\ell+2)}{\ell+2} 
% %      f
% %      + \frac{|\mathcal{P}|-f\cdot(\ell+2)}{\ell+1} \\
% %      & =\frac{|\mathcal{P}|}{\ell+1} - \frac{f}{\ell+1} \\
% %      & \ge\frac{|\mathcal{P}|}{\ell+1} - \frac{s_{\ell+1}}{\ell+1} \\
% %      % s_{\ell+1}
% %      % + \frac{|\mathcal{P}|-s_{\ell+1}\cdot(\ell+2)}{\ell+1} \\
% %      % & = s_{\ell+1} + \frac{|\mathcal{P}|}{\ell+1}-\frac{s_{\ell+1}\cdot(\ell+2)}{\ell+1} \\
% %      % & = s_{\ell+1} + \frac{|\mathcal{P}|}{\ell+1}-s_{\ell+1}
% %      % - \frac{s_{\ell+1}}{\ell+1}\\
% %      % & = \frac{|\mathcal{P}|}{\ell+1}
% %      % - \frac{s_{\ell+1}}{\ell+1}\\
% %      & \ge \frac{|B|-(\ell+1)\cdot|A\cap B|}{\ell+1}
% %      - \frac{s_{\ell+1}}{\ell+1}\\
% %      & = \frac{|W_{\ell+1}|-|A\setminus B|}{\ell+1}
% %      - \frac{s_{\ell+1}}{\ell+1} - |A\cap B|\\
% %      & = \frac{s_{\ell+1}+(\ell+1)\cdot|W|-|A\setminus B|}{\ell+1}
% %      - \frac{s_{\ell+1}}{\ell+1} - |A\cap B|\\
% %      % & = \frac{(\ell+1)\cdot|W|-|S|-(\ell+2)\cdot|A\cap B|}{\ell+1} \\
% %      & = |W|-\frac{|A\setminus B|}{\ell+1}-|A\cap B| \enspace .
% %   \end{align*}
% % \hussein{It seems to me that we are counted the paths that goes to the full vertices inside $P$ as well, then we remove them. I don't know if we can be a little bit efficient!} \pat{I thought that for a moment, too, but now I don't.  We count the number of full vertices $f$ and the number of non-full vertices $|W\cap B|-f$.}\hussein{Ok, I will read it again, I got distracted with students.}

% %   Therefore,
% %   \[
% %     |(A\setminus B)\cap W|=|W|-|B\cap W|\le \frac{|A\setminus B|}{\ell+1}+ |A\cap B| \enspace . \qedhere
% %   \]
% % \end{proof}


% % \begin{lem}\label{w_splitter}
% %   Let $G$ be a graph and let $W_0,\ldots,W_{\ell},W_{\ell+1}$ be a $W$-sequence of width $w$ in $G$, for some $W\subseteq V(G)$ and some $w\le |W_0|$. Let $i\in\{0,\ldots,\ell+1\}$ and let $(A,B)$ be a separation of $G[W_{i}]$ of order at most $a$.
% %   \[
% %     |A\cap W_0|\le |W_0|-\frac{|B|}{i+1}+a \enspace .
% %   \]
% % \end{lem}

% % \begin{proof}
% %   Let $\Delta_0,\ldots,\Delta_{\ell+1}$ and $s_0,\ldots,s_{\ell+1}$ be as in the definition of $W_0$-sequence.
% %   For each $j\in\{0,\ldots,\ell\}$, let $B_j:=B\cap \Delta_j$ and let $\mathcal{P}_j$ be a set of $|B_j|$ pairwise vertex-disjoint $B_j$-$W$ paths in $G[W_j]$.  (The existence of $|B_j|$ such paths is part of the definition of $W$-sequence.)  Since the paths in $\mathcal{P}_j$ are pairwise vertex-disjoint, at most $a$ of the paths in $\mathcal{P}_j$ contain a vertex of $A\cap B$.  Therefore, $\mathcal{P}_j$ contains a subset $\mathcal{P}_j'$ of size at least $|\mathcal{P}_j|-a$ made up of paths that are contained in $G[B\setminus A]$.  Let $\mathcal{P}:=\bigcup_{j=1}^{\ell} \mathcal{P}_j'$. Then,
% %   \[
% %     |\mathcal{P}|=\sum_{j=0}^{i}|\mathcal{P}_j'| \ge \sum_{j=0}^{i}|\mathcal{P}_j| - a(i+1)
% %     = |B|-a(i+1) \enspace .
% %   \]
% %   Each path in $\mathcal{P}$ ends at a vertex in $W_0\setminus A$.  Each vertex in $W_0\setminus A$ is an endpoint of at most one path in $\mathcal{P}'_j$, for each $j\in\{0,\ldots,i\}$.  Therefore, each vertex in $W_0\setminus A$ is the endpoint of at most $i+1$ paths in $\mathcal{P}$.  Therefore,
% %   \[
% %     |W_0\setminus A|\ge \frac{|\mathcal{P}|}{i+1} \ge \frac{|B|}{i+1}-a \enspace .
% %   \]
% %   Therefore,
% %   \[
% %     |W_0\cap A|=|W_0|-|W_0\setminus A|\le |W_0|-\frac{|B|}{i+1}+a \enspace . \qedhere
% %   \]
% % \end{proof}


% % \begin{cor}\label{balanced_corollary}
% %   Let $G$ be a graph, let $W_0,\ldots,W_\ell,W_{\ell+1}$ be $W$-sequence of width $w$ in $G$, for some $W\subseteq V(G)$ and some $w\le |W_0|$, and let $\Delta_{\ell+1}:=W_{\ell+1}\setminus W_{\ell}$.
% %   % Then there exists a separation $(X,Y)$ of $G$ with $W_0\subseteq Y$
% %   Let $(A,B)$ be a separation of $G[W_{\ell+1}]$ of order at most $a$.   Then
% %   \[
% %     |A\cap W_0|\le |W_0|-\frac{|\Delta_{\ell+1}| + \ell w +|W_0|}{3(\ell+2)}+a \enspace .
% %   \]
% % \end{cor}

% % \begin{proof}
% %   Let $\Delta_0,\ldots,\Delta_{\ell+1}$ and $s_0,\ldots,s_{\ell+1}$ be as in the definition of $W_0$-sequence.
% %   Since $(A,B)$ is balanced separation of $G[W_i]$, $|A\setminus B|\le \frac{2}{3}|W_{i}|$, so $|B|=|W_{i}|-|A\setminus B|\ge \tfrac{1}{3}|W_{i}|$.  Applying \cref{w_splitter} with $i=\ell+1$, we obtain
% %   \begin{align*}
% %     |A\cap W_0|
% %     & \le |W_0|-\frac{|B|}{\ell+2}+a\\
% %     & \le |W_0|-\frac{|W_{\ell}|}{3(\ell+2)}+a \\
% %     & = |W_0|-\frac{\Delta_{\ell+1} + \ell w +|W_0|}{3(\ell+2)}+a \enspace . \qedhere
% %   \end{align*}

% % \end{proof}

% % Setting $w:=|W_0|$ in \cref{balanced_corollary} we obtain:

% % \begin{cor}\label{uniform_balanced_corollary}
% %   Let $G$ be a graph, let $W_0\subseteq\cdots\subseteq W_\ell\subseteq W_{\ell+1}$ be $W$-sequence of width $|W|$ in $G$, for some $W\subseteq V(G)$.
% %   % Then there exists a separation $(X,Y)$ of $G$ with $W_0\subseteq Y$
% %   Let $(A,B)$ be a balanced separation of $G[W_{\ell+1}]$ of order at most $a$.  Then
% %   \[
% %     |A\cap W_0|\le \left(\frac{2}{3}+\frac{1}{3(\ell+2)}\right)|W_0|+a \enspace .
% %   \]
% % \end{cor}

% \begin{lem}\label{z_corollary}
%   Let $G$ be a graph, let $W\subseteq V(G)$, let $W_0\subseteq\cdots\subseteq W_\ell\subseteq W_{\ell+1}$ be a $W$-sequence of width $|W|$ in $G$, let $\Delta_{\ell+1}:=W_{\ell+1}\setminus W_{\ell}$,  and let $Z\subseteq W_{\ell+1}$, $|Z|=|\Delta_{\ell+1}$, separate $V(G)\setminus W_{\ell}$ and $W$ in $G$.
%   Then every $(V(G)\setminus W_{\ell},Z,W)$-separation $(X,Y)$ of $G$ has the property that, for any separation
%   $(A,B)$ of $G[W_{\ell+1}]$,
%   \[
%     |Z\setminus B|\le \frac{|A\setminus B|}{\ell+2}+\frac{2\ell+2}{\ell+2}\cdot|A\cap B|  \enspace .
%   \]
% \end{lem}

% \begin{proof}
%   By the definition of $W$-sequence, there exists a set $\mathcal{P}_{\ell+1}$ of $|Z|$ pairwise vertex-disjoint $\Delta_{\ell+1}$-$W$ paths.  Each of the paths in $\mathcal{P}_{\ell+1}$ contains a distinct vertex in $Z$.  Let $\mathcal{P}^\star:=\{P\in\mathcal{P}_{\ell+1}: V(P)\cap (Z\setminus B)\neq\emptyset\}$, so $|\mathcal{P}^\star|=|Z\setminus B|$.  Partition $\mathcal{P}^\star$ into three sets:
%   \begin{enumerate}[nosep,nolistsep]\setcounter{enumi}{-1}
%       \item $\mathcal{P}^\star_0$ are the paths in $\mathcal{P}^\star$ that start at a vertex of $\Delta_{\ell+1}\setminus B$ and end at a vertex in $W\setminus B$.
%       \item $\mathcal{P}^\star_1$ are the paths in $\mathcal{P}^\star$ that start at a vertex in $\Delta_{\ell+1}\cap B$ and end at a vertex in $W\setminus B$.
%       \item $\mathcal{P}^\star_2$ are the paths in $\mathcal{P}^\star$ that start at a vertex in $\Delta_{\ell+1}\setminus B$ and end at a vertex in $W\cap B$.
%   \end{enumerate}
%   Since the paths in $\mathcal{P}_0^\star\cup\mathcal{P}_1^\star$ are pairwise vertex-disjoint and each contains a vertex of $W\setminus B$, $|\mathcal{P}_0^\star|+|\mathcal{P}_1^\star|\le|W\setminus B|$.
%   Each path in $\mathcal{P}_1^\star\cup \mathcal{P}_2^\star$ contains a vertex in $Z\setminus B$ and a vertex in $W\cap B$.  Since $(A,B)$ is a separation of $G[W_{\ell+1}]$ this implies that each path in $\mathcal{P}_1^\star\cup \mathcal{P}_2^\star$ contains a vertex in $A\cap B$. Since the paths in  $\mathcal{P}_1^\star\cup \mathcal{P}_2^\star$ are pairwise vertex-disjoint, this implies that $|\mathcal{P}_1^\star\cup \mathcal{P}_2^\star|\le |A\cap B|$. Therefore,
%   \begin{equation}
%      |Z\setminus B| = |\mathcal{P}^\star| = |\mathcal{P}_0^{\star}| + |\mathcal{P}_1^\star| + |\mathcal{P}_2^{\star}|
%      \le |W\setminus B| + |\mathcal{P}_2^\star|
%      \le \frac{|A\setminus B|-|\Delta_{\ell+1}\setminus B|}{\ell+1}+|A\cap B|+|\mathcal{P}_2^\star| 
%      \enspace , \label{coolio}
%   \end{equation}
%   where the last inequality is an application of \cref{uniform_balance}. Since each path in $\mathcal{P}_0^\star\cup\mathcal{P}^\star_2$ starts at a distinct vertex in $|\Delta_{\ell+1}\setminus B|$, we have $|\Delta_{\ell+1}\setminus B|\ge |\mathcal{P}_0^\star|+|\mathcal{P}^\star_2|=|Z\setminus B|-|\mathcal{P}_1^\star|$.
%   Using this inequality in \cref{coolio} we obtain
%   \[
%      |Z\setminus B| \le \frac{|A\setminus B|-|Z\setminus B|+|\mathcal{P}_1^\star|}{\ell+1}+|A\cap B|+|\mathcal{P}_2^\star| \enspace .
%   \]
%   Rewriting this equation to isolate $|Z\setminus B|$, we obtain
%   \begin{align*}
%      |Z\setminus B|
%      & \le \frac{|A\setminus B|+|\mathcal{P}_1^\star|}{\ell+2} + \frac{\ell+1}{\ell+2}\cdot
%         \left(|A\cap B|+|\mathcal{P}_2^\star|\right) \\
%      & \le \frac{|A\setminus B|}{\ell+2} + \frac{2\ell+2}{\ell+2}\cdot|A\cap B|
%         \enspace . \qedhere
%   \end{align*}
% \end{proof}

\hussein{I read this lemma, it seems correct for me. I lost the intuitive idea after the first half. I think the constant in front of $|A\setminus B|$ is $3$ as I show down in red.}
\begin{lem}\label{z_w_bound}
  Let $G$ be a graph, let $W\subseteq V(G)$, let $W_0,\ldots,W_{\ell+1}$ be a $W$-sequence of width $|W|$ in $G$ with $\ell\ge 1$, let $\Delta_{\ell+1}:=W_{\ell+1}\setminus W_{\ell}$,  and let $Z\subseteq W_{\ell+1}$, $|Z|=|\Delta_{\ell+1}|$, separate $V(G)\setminus W_{\ell}$ and $W$ in $G$.
  Then every $(V(G)\setminus W_{\ell},Z,W)$-separation $(X,Y)$ of $G$ has the property that, for any separation
  $(A,B)$ of $G[W_{\ell+1}]$,
  \[
    |W\setminus B|+|Z\setminus B|\le \frac{2\,|A\setminus B|}{\ell+2}+3\,|A\cap B| \enspace .
  \]
\end{lem}

\pat{Something to consider: Drop $Z$ in favour of just discussing the separation $(X,Y)$.  Then the statement simplifies(?) to: \\[2ex]
  Let $G$ be a graph, let $W\subseteq V(G)$, let $W_0,\ldots,W_{\ell+1}$ be a $W$-sequence of width $|W|$ in $G$ with $\ell\ge 1$.  Then there exists a separation $(X,Y)$ of $G$ having order $|X\cap Y|=|W_{\ell+1}\setminus W_{\ell}|$ such that, for any separation $(A,B)$ of $G[W_{\ell+1}]$,
  \[
    |W\setminus B|+|(X\cap Y)\setminus B|\le \frac{2\,|A\setminus B|}{\ell+2}+3\,|A\cap B| \enspace .
  \]
} 

\begin{rem}\label{easier_path}
  The proof of \cref{z_w_bound} requires some extra effort to obtain $\ell+2$ in the denominator. The reader who is not interested in precise constants can already stop at \cref{z_b_bound} in the proof, from which the bound
  \[
    |W\setminus B|+|Z\setminus B|\le \frac{2|A\setminus B|}{\ell+1} + 3|A\cap B| 
  \]
  follows immediately.
  This weaker bound is still sufficient to prove \cref{main_result} with the constant $c< 68$.
\end{rem}

\begin{proof}
  Let $W_{-1}:=\emptyset$ and, for each $i\in\{0,\ldots,\ell+1\}$, let $\Delta_{i}:=W_{i}\setminus W_{i-1}$ (as in the definition of $W$-sequence).
  By the definition of $W$-sequence, $G[W_{i}]$ contains a set $\mathcal{P}_i$ of $|W\setminus B|$ pairwise vertex-disjoint $\Delta_i$-$(W\setminus B)$ paths, for each $i\in\{0,\ldots,\ell+1\}$.  \hussein{I think the last statement is not true for $\ell + 1$.}
  
  We begin by bounding $|W\setminus B|$ using the path sets $\mathcal{P}_0,\ldots,\mathcal{P}_{\ell}$.  For each $i\in\{0,\ldots,\ell\}$, let $\mathcal{Q}_i\subseteq \mathcal{P}_i$ contain the paths in $\mathcal{P}_i$ that begin at a vertex in $A\setminus B$ and let $\overline{\mathcal{Q}}_i:=\mathcal{P}_i\setminus \mathcal{Q}_i$ contain the paths in $\mathcal{P}_i$ that begin at a vertex in $B$.  Since each path in $\mathcal{Q}_i$ begins at a distinct vertex in $\Delta_i\setminus B$, $|\mathcal{Q}_i|\le|\Delta_i\setminus B|$. Each path in $\overline{\mathcal{Q}}_i$ begins at a vertex in $B$ and ends at a vertex in $W\setminus B$. Since $(A,B)$ is a separation of $G[W_{\ell+1}]$, this implies that each path in $\overline{\mathcal{Q}}_i$ contains a vertex in $A\cap B$.  Since the paths in $\overline{\mathcal{Q}}_i$ are pairwise vertex-disjoint, $|\overline{\mathcal{Q}}_i|\le |A\cap B|$.
  
  Each vertex $w\in W\setminus B$ is the last vertex of exactly one path in $\mathcal{P}_i$, for each $i\in\{0,\ldots,\ell\}$. Thus, each vertex $w\in W\setminus B$ is the endpoint of exactly $\ell+1$ paths in $\bigcup_{i=0}^\ell\mathcal{P}_i$.  Since $\{\Delta_0,\ldots,\Delta_{\ell+1}\}$ is a partition of $W_{\ell+1}$, we have:
  \begin{align}
  \begin{split}
    |W\setminus B| 
      & = \frac{1}{\ell+1}\cdot\sum_{i=0}^{\ell}|\mathcal{P}_i| \\
      & = \frac{1}{\ell+1}\cdot\sum_{i=0}^{\ell}\left(|\mathcal{Q}_i|+|\overline{\mathcal{Q}_i}|\right) \\
      & \le \frac{1}{\ell+1}\cdot\sum_{i=0}^{\ell}\left(|\Delta_i\setminus B|+|A\cap B|\right) \\
      & = \frac{|W_\ell\setminus B|}{\ell+1} + |A\cap B| \\
      & = \frac{|A\setminus B|-|\Delta_{\ell+1}\setminus B|}{\ell+1} + |A\cap B| \enspace .  \label{w_b_bound}
  \end{split}
  \end{align}

Next, we bound $|Z\setminus B|$.  By the definition of $W$-sequence, $G[W_{\ell+1}]$ has a set $\mathcal{R}$ of $|\Delta_{\ell+1}|=|Z|$ pairwise vertex-disjoint $\Delta_{\ell+1}$-$W$ paths.  Let $\mathcal{P}^\star:=\{P\in\mathcal{R}: V(P)\cap (Z\setminus B)\neq\emptyset\}$.\pat{Mar 3: Fixed a typo in this definition. We care about paths in $\mathcal{R}$, not $\mathcal{P}_{\ell+1}$.} Since each of the paths in $\mathcal{R}$ contains a distinct vertex in $Z$, $|\mathcal{P}^\star|=|Z\setminus B|$.  Partition $\mathcal{P}^\star$ into three sets:
  
\hussein{Note: there are paths that start at $W\cap B$ and end in $W\setminus B$ and avoid $Z\setminus B$. We do not care about them for now! There are not in $\mathcal{P}^*$.} \pat{Do you mean ``that start in $\Delta_{\ell+1}\setminus B$''?}
\hussein{This is not important, the note is just to help me while I am reading. }
  \begin{enumerate}[nosep,nolistsep]\setcounter{enumi}{-1}
      \item $\mathcal{P}^\star_0$ are the paths in $\mathcal{P}^\star$ that start at a vertex of $\Delta_{\ell+1}\setminus B$ and end at a vertex in $W\setminus B$.
      \item $\mathcal{P}^\star_1$ are the paths in $\mathcal{P}^\star$ that start at a vertex in $\Delta_{\ell+1}\cap B$ and end at a vertex in $W\setminus B$.
      \item $\mathcal{P}^\star_2$ are the paths in $\mathcal{P}^\star$ that start at a vertex in $\Delta_{\ell+1}\setminus B$ and end at a vertex in $W\cap B$.
  \end{enumerate}
  Since the paths in $\mathcal{P}_0^\star\cup\mathcal{P}_1^\star$ are pairwise vertex-disjoint and each contains a vertex of $W\setminus B$, $|\mathcal{P}_0^\star|+|\mathcal{P}_1^\star|\le|W\setminus B|$.
  Each path in $\mathcal{P}_1^\star\cup \mathcal{P}_2^\star$ contains a vertex in $Z\setminus B$ and a vertex in $W\cap B$.  Since $(A,B)$ is a separation of $G[W_{\ell+1}]$ this implies that each path in $\mathcal{P}_1^\star\cup \mathcal{P}_2^\star$ contains a vertex in $A\cap B$. Since the paths in  $\mathcal{P}_1^\star\cup \mathcal{P}_2^\star$ are pairwise vertex-disjoint, this implies that $|\mathcal{P}_1^\star\cup \mathcal{P}_2^\star|\le |A\cap B|$. Therefore,
  \begin{equation}
     |Z\setminus B| = |\mathcal{P}^\star| = |\mathcal{P}_0^{\star}| + |\mathcal{P}_1^\star| + |\mathcal{P}_2^{\star}|
     \le |W\setminus B| + |\mathcal{P}_2^\star|
     \le \frac{|A\setminus B|-|\Delta_{\ell+1}\setminus B|}{\ell+1}+|A\cap B|+|\mathcal{P}_2^\star| 
     \enspace , \label{coolio}
  \end{equation}
  where the last inequality is an application of inequality~\eqref{w_b_bound}.  At this point, adding \eqref{w_b_bound} and \eqref{coolio} and using the inequality $|\mathcal{P}_2^\star| \le |\mathcal{P}_1^\star\cup\mathcal{P}_2^\star|\le |A\cap B|$ immediately gives the bound discussed in \cref{easier_path}.  With a bit more work, we can do better.  Since each path in $\mathcal{P}_0^\star\cup\mathcal{P}^\star_2$ starts at a distinct vertex in $\Delta_{\ell+1}\setminus B$, 
  \begin{equation}
      |\Delta_{\ell+1}\setminus B|\ge |\mathcal{P}_0^\star|+|\mathcal{P}^\star_2|=|Z\setminus B|-|\mathcal{P}_1^\star| \enspace . \label{z_b_trick} 
  \end{equation}
  Using inequality~\eqref{z_b_trick}  in \cref{coolio} we obtain
  \[
     |Z\setminus B| \le \frac{|A\setminus B|-|Z\setminus B|+|\mathcal{P}_1^\star|}{\ell+1}+|A\cap B|+|\mathcal{P}_2^\star| \enspace .
  \]
  Rewriting this equation to isolate $|Z\setminus B|$, we obtain
  \begin{align}
     |Z\setminus B|
      & \le \frac{|A\setminus B|+|\mathcal{P}_1^\star|}{\ell+2} + \left(\frac{\ell+1}{\ell+2}\right)\cdot
        \left(|A\cap B|+|\mathcal{P}_2^\star|\right) \\
      & < \frac{|A\setminus B|}{\ell+2} + 
        |A\cap B|+|\mathcal{P}_2^\star|+\tfrac{1}{3} |\mathcal{P}_1^\star|
     % & \le \frac{|A\setminus B|}{\ell+2} + \frac{2\ell+2}{\ell+2}\cdot|A\cap B|
        \enspace . \label{z_b_bound} 
  \end{align}
  (The second inequality uses the assumption that $\ell\ge 1$.) Using inequality~\eqref{z_b_trick}  in \cref{w_b_bound} we obtain, 
  \begin{equation}
      |W\setminus B|+\frac{|Z\setminus B|}{\ell+1}\le \frac{|A\setminus B|+|\mathcal{P}_1^\star|}{\ell+1} + |A\cap B|
      \le \frac{|A\setminus B|}{\ell+1} + |A\cap B| +\tfrac{1}{2}|\mathcal{P}_1^\star| \enspace .  \label{w_b_bound_two}
  \end{equation}
  (The second inequality again uses the assumption that $\ell\ge 1$.) Adding \eqref{w_b_bound_two} and \eqref{z_b_bound} and using the fact that $\tfrac{5}{6}|\mathcal{P}_1^\star|+|\mathcal{P}_2^\star|\le|\mathcal{P}_1^\star|+|\mathcal{P}_2^\star|\le |A\cap B|$, we obtain
  \begin{align}
    |W\setminus B| + \left(\frac{\ell+2}{\ell+1}\right)\cdot|Z\setminus B|
    & \le \frac{|A\setminus B|}{\ell+1} + 
    \frac{|A\setminus B|}{\ell+2} + 2\,|A\cap B| + \tfrac{5}{6}|\mathcal{P}_1^\star|+|\mathcal{P}_2^\star| \\ 
    & \le \frac{|A\setminus B|}{\ell+1} + 
    \frac{|A\setminus B|}{\ell+2} + 3\,|A\cap B| \label{sum_bound}
  \end{align}
  We can now upper bound $|W\setminus B|+|Z\setminus B|$ by maximizing $x_0+x_1$ subject to
  \begin{equation}
     x_0+\left(\frac{\ell+2}{\ell+1}\right)\cdot x_1 \le R \enspace , \label{sum_bound_two}   
  \end{equation}
  where $R$ denotes the expression in \eqref{sum_bound}.
  For a fixed $x_0=x^\star_0$ the maximum value of $x_1$ that satisfies \eqref{sum_bound_two} is 
  \[ 
    x_1 = x_1^\star:=\left(\frac{\ell+1}{\ell+2}\right)\cdot(R-x^{\star}_0)
  \]
  in which case 
  \[
     x_0 + x_1 = x^\star_0+x^\star_1 = \left(\frac{\ell+1}{\ell+2}\right)\cdot R + \frac{x^\star_0}{\ell+2} 
  \]
  maximizes $x_0+x_1$ subject to fixed $x_0=x_0^{\star}$.
  This is an increasing linear function of $x_0^{\star}$.  From \eqref{w_b_bound}, we have the constraint
  \[
     x_0^\star \le 
     \frac{|A\setminus B|-\mathcolor{red}{|\Delta_{\ell+1}\setminus B|}}{\ell+1}+|A\cap B|
     \le \frac{|A\setminus B|}{\ell+1}+|A\cap B|
  \]
  from which we obtain the upper bound
  \begin{align*}
    |W\setminus B|+|Z\setminus B|
    & \le \left(\frac{\ell+1}{\ell+2}\right)\cdot R + 
    \frac{x_0^\star}{\ell+2} \\
    & \le \left(\frac{\ell+1}{\ell+2}\right)\left(\frac{|A\setminus B|}{\ell+1}+\frac{|A\setminus B|}{\ell+2}+3\,|A\cap B|\right)+\frac{|A\setminus B|}{(\ell+1)
    (\ell+2)}
    + \frac{|A\cap B|}{\ell+2}
    \\
    % \left(\frac{1}{\ell+2}\right)\left(}{\ell+1}+|A\cap B|\right) +\left(\frac{17(\ell+1)}{6(\ell+2)}\right)\cdot|A\cap B| \\
    & = \frac{|A\setminus B|}{\ell+2}\cdot\left(\frac{\ell+1}{\ell+1}+\frac{\ell+1}{\ell+2}+\frac{1}{\ell+1}\right) +\left(\frac{3\ell+4}{\ell+2}\right)\cdot |A\cap B|  \\
    & = \frac{|A\setminus B|}{\ell+2}\cdot\left(2-\frac{1}{\ell+2}+\frac{1}{\ell+1}\right) +\left(\frac{3\ell+4}{\ell+2}\right)\cdot |A\cap B|  \\
    % & < \frac{|A\setminus B|}{\ell+2}\cdot\left(\frac{\ell+1}{\ell+1}+\frac{\ell+1}{\ell+2}+\frac{1}{(\ell+2)}\right) +\left(\frac{3\ell+4}{\ell+2}\right)\cdot |A\cap B|  \\
    % & \text{\pat{I've added a step (previous line) that (hopefully) explains better.}}\\
    % & \text{\pat{We just use $1/(\ell+1)(\ell+2)<1/(\ell+2)$. Please check.}}\\
    % & \text{\hussein{The term in purple should be $1/(\ell + 1)$ because of if you expand you do not get an equality!}}\\
    % & \text{\pat{Ah, of course!  I've got a meeting now, but I'll come back to this after.} }\\
    % & \text{\pat{For now, I see $2+1/(\ell+1)-1/(\ell+2)\le 2+\tfrac{1}{6}$.}} \\
    % & < \mathcolor{red}{\frac{|A\setminus B|}{\ell + 2}\left(\frac{\ell + 1}{\ell + 1} + \frac{\ell + 1}{\ell + 2} + \frac{1}{\ell + 1}\right)} + \frac{3\ell + 4}{\ell + 2}|A\cap B| ?? \\
    % & < \mathcolor{red}{\frac{|A\setminus B|}{\ell + 2}\left(1 + \frac{(\ell + 1)^2 + \ell + 2}{(\ell + 2) (\ell + 1)} \right)}\\
    % & < \mathcolor{red}{\frac{|A\setminus B|}{\ell + 2}\left(1 + \frac{\ell^2 +2\ell + 1 + \ell + 2}{\ell^2 + \ell + 2\ell + 2 } \right)}\\
    % & < \mathcolor{red}{\frac{|A\setminus B|}{\ell + 2}\left(1 + \frac{\ell^2 +3\ell + 3}{\ell^2 + 3\ell + 2 } \right)}\\
    % & < \mathcolor{red}{\frac{3|A\setminus B|}{(\ell + 2)} + 3|A\cap B|???}\\
    % & \text{\pat{Continue here.}} \\
    & < \frac{(2+\tfrac{1}{6})\,|A\setminus B|}{\ell+2} + 3\,|A\cap B| \enspace . \qedhere
  \end{align*}
\end{proof}

\pat{The ${}+\tfrac{1}{6}$ is annoying, and probably unnecessary.  It could probably be eliminated by being more careful with the upper bound on $x_0^{\star}$, which is giving up $|\Delta_{\ell+1}\setminus B|/(\ell+1)\\ge (|Z\setminus B|-|\mathcal{P}_1^{\star}|)/(\ell+1)$.  We may have to iterate this argument...  I'm taking this offline to fight with it.}

% \pat{Continue here.}

% \begin{lem}\label{z_corollary}
%   Let $G$ be a graph, let $W_0\subseteq\cdots\subseteq W_\ell\subseteq W_{\ell+1}$ be a $W$-sequence of width $|W|$ in $G$, for some $W\subseteq V(G)$ and let $Z$ be as in the definition of $W$-sequences.
%   Then every $(V(G)\setminus W_{\ell},Z,W)$-separation $(X,Y)$ of $G$ has the property that, for any separation
%   $(A,B)$ of $G[W_{\ell+1}]$,
%   \[
%     |(A\setminus B)\cap Z|\le \frac{|A\setminus B|-|\Delta_{\ell+1}\setminus B|}{\ell+1}+ 2|A\cap B|  \enspace .
%   \]
% \end{lem}

% \begin{proof}
%   Let $\Delta_{\ell+1}:=W_{\ell+1}\setminus W_\ell$.
%   % From the definition of $W$-sequence, the set $Z\subseteq W_{\ell+1}$ of size $s_{\ell+1}:=|\Delta_{\ell+1}|$ separates $V(G)\setminus W_\ell$ and $W$ in $G$.  
%   Let $(X,Y)$ be an $(V(G)\setminus W_\ell,Z,W)$-separation.  By the definition of $W$-sequence, $G[W_{\ell+1}]$ contains a set $\mathcal{S}$ of $|Z|=s_{\ell+1}$ pairwise vertex-disjoint $\Delta_{\ell+1}$-$W$ paths, each of which contains a distinct vertex in $Z$.  For each $z\in Z$, let $P_z$ be the unique path in $\mathcal{S}$ that contains $z$. 
%   % and let $P_z'$ be the subpath of $P_z$ that begins at $z$ and ends at the first vertex of $P_z$ contained in $W$.
  
%   % .  Ea
  
  
%   % $P_1,\ldots,P_{s_{\ell+1}}$.
%   % For each $j\in\{1,\ldots,s_{\ell+1}\}$, $P_j$ contains exactly one vertex in $Z$.  For each $j\in\{1,\ldots,s_{\ell+1}\}$, let $P'_j$ be the subpath of $P_j$ that begins at the unique vertex of $P_j$ in $Z$ and ends at the first vertex of $P_j$ in $W$.

%   % For each $z\in Z$, let $P_z$ be the path in $P'_1,\ldots,P'_{s_\ell+1}$ that begins at $z$.
%   % For each $z\in Z$, $P_z$ is contained in $G[Y]$ since the first vertex of $P_z$ is in $Z\subseteq Y$, the last vertex of $P_z$ is in $W\subseteq Y$ and $P_z$ has no internal vertex in $Z=X\cap Y$.
%   The set $\{P_z:z\in Z\setminus B\}$ contains $|Z\setminus B|=|(A\setminus B)\cap Z|$ pairwise vertex-disjoint $\Delta_{\ell+1}$-$W$ paths.
%   % ,
%   % each of which is contained in $Y$.
%   Since the paths in $\{P_z:z\in Z\setminus B\}$ are pairwise vertex disjoint, at most $|A\cap B|$ of these paths contain a vertex of $A\cap B$. Therefore, there are at least $|Z\setminus B|-|A\cap B|$ paths in $\{P_z:z\in Z\setminus B\}$ that are contained in $G[A\setminus B]$.  Each of these paths ends at a distinct vertex in $W\setminus B$.  Therefore,
%   \begin{align*}
%      |(A\setminus B)\cap Z|-|A\cap B| \le |\{P_z:z\in Z\setminus B\}| \le |W\setminus B| \le
%      \frac{|A\setminus B|}{\ell+1}+|A\cap B| \enspace ,
%   \end{align*}
%   where the second inequality is an application of \cref{uniform_balance}.  Adding $|A\cap B|$ to both sides of this inequality establishes the lemma.
% \end{proof}

We are now ready to prove \cref{main_result}.

\hussein{$t$ might be $33$!}  \pat{I think the previous proof gives the numbers below.}

\begin{proof}[Proof of \cref{main_result}]
  Let $G$ be a graph and let $a:=\sep(G)$.  Let
  \[
    h:=4 \quad\text{and}\quad t:=\frac{4h}{1-2\cdot(\tfrac{2}{3})^{h}} < 26.449 \enspace .
  \]
  We will show that $\tw(G)< (2t+1)a$. The proof is by induction on the number of vertices of $G$. We will prove the following stronger statement: For any graph $G$ and any non-empty subset $W\subseteq V(G)$ of size at most $ta$, $G$ has a tree decomposition $(B_x:x\in V(T))$ of width less than $(2t+1)a$ in which $W\subseteq B_x$ for some $x\in V(T)$.

  If $G$ has less than $ta$ vertices, then the proof is trivial. We use a tree $T$ with a single vertex $x$ and set $B_x:=V(G)$.  We now assume that $|V(G)|\ge ta$. By adding vertices to $W$ arbitrarily, we may assume that $|W|=ta$. By \cref{w_sequence}, $G$ has a $W$-sequence $W_0,\ldots,W_{\ell+1}$ of width $|W|=ta$.   Let $\Delta_0,\ldots,\Delta_{\ell+1}$, $s_0,\ldots,s_{\ell+1}$, and $Z$ be as in the definition of $W$-sequence.  Let $(X,Y)$ be a $(V(G)\setminus W_{\ell},Z,W)$-separation.
 % \pat{Don't forget to mention \cref{z_corollary} here.}

  Since $|X\cap Y|=|Z|<|W|=ta$, the inductive hypothesis implies that $G[X]$ has a tree decomposition $(B_x:x\in V(T_1))$ of width less than $(2t+1)a$ in which $Z\subseteq B_x$ for some $x_1\in V(T_1)$.  To finish the proof, we construct a tree decomposition $(B_x:x\in V(T_0))$ of $G[Y]$ of width less than $(2t+1)a$ in which some bag $B_{x_0}$ contains $W\cup Z$.  Then the tree $T$ obtained by joining $T_0$ and $T_1$ using the edge $x_1x_0$ gives the desired tree decomposition $(B_x:x\in V(T))$. 
  
  If $\ell=0$ then we use the trivial tree decomposition in which $T_0$ has a single node $x_0$ where $B_{x_0}:=W\cup Z$.  Since $W\cup Z\subseteq Y$ and $|Y|=|W_1|=|W|+|Z|< 2|W|=(2t+1)a$, this decomposition has width less than $(2t+1)a$. We now assume that $\ell\ge  1$.

 % We distinguish between two cases, depending on the value of $\ell$.

 % If $\ell=0$, then $T_0$ consists of a single edge $x_0x_0'$ with $B_{x_0}:=W$ and $B_{x_{0}'}:=Z$.  The tree decomposition $(B_x:x\in V(T_0))$ satisfies our requirements and has width less than $|W|=ta$.

 % The root $r$ of $T_0$ will have the bag $B_r:=W\cup Z$.  (This already satisfies the requirement from the previous paragraph with $x_0:=x_0':=r$.)
  % By the definition of separation number, $\sep(G[Y])\le \sep(G)\le a$.
  Since $\ell \ge 1$, $W_0,\ldots,W_{\ell+1}$ satisfies the conditions of \cref{z_w_bound}.
  Let $\mathcal{T}'_0:=(B'_x:x\in V(T_0'))$ be the tree decomposition of $G[W_{\ell+1}]$ obtained by applying \cref{separation_tree} to $G[W_{\ell+1}]$.  The following claim will be used to bound the width of a tree decomposition that we derive from $\mathcal{T}'_0$.

\hussein{I think, the 3 in lemma 6 should appears in the $3ta$!}
  \begin{clm} \label{cell_bound}
     For each $d\in\{0,\ldots,h\}$ and 
     each node $x$ of $T_0$ with $|\interior_{\mathcal{T}'_0}(x)|\le (\tfrac{2}{3})^d\cdot |W_{\ell+1}|$,
     \begin{equation}
       |\interior_{\mathcal{T}'_0}(x)\cap (W\cup Z)|  \le 2ta\cdot (\tfrac{2}{3})^{d-1}+3da \label{t_bound}
     \end{equation}
   \end{clm}

  % We observe that, for $d=6$ and $t\ge 34$, the bound in \eqref{t_bound} is at most $ta$.

  \begin{clmproof}
  Consider the separation 
  \[  
    (A,B):=(\interior_{\mathcal{T}'_0}(x)\cup\boundary_{\mathcal{T}'_0}(x),W_{\ell+1}\setminus\interior_{\mathcal{T}'_0}(x))
  \] 
  of $G[W_{\ell+1}]$ and observe that $A\setminus B:=\interior_{\mathcal{T}'_0}(x)$.
  By \cref{z_w_bound},
  % \begin{align*}
  %   |\interior_{\mathcal{T}'_0}(x)\cap W| = |W\setminus B| 
  %   & \le \frac{|A\setminus B|-|\Delta_{\ell+1}\setminus B|}{\ell+1} +  |A\cap B| \\
  %   & \le \frac{|A\setminus B|-|Z\setminus B|+|A\cap B|}{\ell+1} +  |A\cap B| \\
  %   & \le \frac{(\tfrac{2}{3})^d\cdot|W_{\ell+1}|-|Z\setminus B|+|A\cap B|}{\ell+1} +  |A\cap B| \\
  %   & < \frac{(\tfrac{2}{3})^d\cdot(\ell+2)\cdot|W|}{\ell+1} +  |A\cap B| \\
  %   % & = \frac{|W_\ell\setminus B|}{\ell+1} +  |A\cap B| \\
  %   % & \le (\tfrac{2}{3})^d\cdot \frac{|W_{\ell+1}|-|\Delta_{\ell+1}\setminus B|}{\ell+1} + da \\
  %   % & = (\tfrac{2}{3})^d\cdot \frac{|W|\cdot (\ell+1)+|Z|-|\Delta_{\ell+1}\setminus B|}{\ell+1} + da \\
  %   % & = (\tfrac{2}{3})^d\cdot \left(|W|+\frac{|Z|}{\ell+1}\right) +  da \\
  %   % & < (\tfrac{2}{3})^d\cdot \left(|W|+\frac{|W|}{\ell+1}\right) +  da
  %   %   & \text{(since $|Z|=s_{\ell+1}<|W|$)} \\
  %   % & \le (\tfrac{2}{3})^d\cdot \left(\tfrac{3}{2}|W|\right) +  da
  %   %   & \text{(since $\ell\ge 1$)} \\
  %   % & = (\tfrac{2}{3})^{d-1}\cdot|W| + da = ta\cdot (\tfrac{2}{3})^{d-1}+da\enspace . \\
  % \end{align*}

  % By \cref{z_corollary} and a similar calculation,
  % \[
  %   |\interior_{\mathcal{T}'_0}(x)\cap Z|
  %     = |(A\setminus B)\cap Z|
  %     \le \frac{|A\setminus B|}{\ell+1} + 2\cdot |A\cap B|
  %     <  ta\cdot (\tfrac{2}{3})^{d-1} + 2da \\
  % \]
  % Therefore
  \begin{align*}
  |\interior_{\mathcal{T}'_0}(x)\cap (W\cup Z)| 
  & = |(A\setminus B)\cap (W\cup Z)| \\
  & \le |W\setminus B| + |Z\setminus B| \\
  & \le 
     \frac{2\,|A\setminus B|}{\ell+2} + 3\,|A\cap B| \\
  & \le \frac{2\,(\tfrac{2}{3})^d|W_{\ell+1}|}{\ell+2} + 3\,|A\cap B| \\
  & = \frac{2\,(\tfrac{2}{3})^d(\ell+1)|W|+|\Delta_{\ell+1}|}{\ell+2} + 3\,|A\cap B| \\
  & < \frac{2\,(\tfrac{2}{3})^d(\ell+2)|W|}{\ell+2} + 3\,|A\cap B| \\
  & = 2ta\cdot(\tfrac{2}{3})^d + 3da \enspace . \qedhere
  \end{align*}
  \end{clmproof}

 For each node $x$ of $T'_0$, define $B_x:=(B'_x\cap Y) \cup (\interior_{\mathcal{T}'_0}(x)\cap (W\cup Z))$ and let $\mathcal{T}''_0:=(B_x:x\in V(T'_0))$.  By \cref{restricted_decomp} (applied with the separation $(X\cup W,Y\cup W)$), $\mathcal{T}''_0$ is a tree decomposition of $G[Y]$. \hussein{Does this require a proof?}

 \begin{clm}\label{leaf_interface}
    For each leaf $x$ of $T'_0$, $|\boundary_{\mathcal{T}''_0}(x)|\le ta$.
 \end{clm}

 \begin{proof}
   Let $x$ be a leaf of $T'_0$ and let $y$ be the parent of $x$.  Then $|\interior_{\mathcal{T}'_0}(x)|\le (\tfrac{2}{3})^h$ and $\boundary_{\mathcal{T}_0''}(x)=B_x\cap B_y\subseteq (B'_x\cap B'_y)\cup(\interior_{\mathcal{T}'_0}(x)\cap (W\cup Z)) = \boundary_{\mathcal{T}_0'}(x)\cup(\interior_{\mathcal{T}'_0}(x)\cap (W\cup Z))$. Therefore, by \cref{separation_tree} and \cref{cell_bound}
   \[
     |\boundary_{\mathcal{T}''_0}(x)| \le |\boundary_{\mathcal{T}'_0}(x)| + |\interior_{\mathcal{T}'_0}(x)\cap (W\cup Z)| \le ha + 2ta\cdot(\tfrac{2}{3})^{h} + 3ha =  2ta\cdot(\tfrac{2}{3})^{h} + 4ha\enspace .
   \]
   The values of $h$ and $t$, defined above, are chosen so that the right hand side of this inequality is equal to $ta$.
 \end{proof}

  By \cref{leaf_interface}, $|\boundary_{\mathcal{T}''_0}(x)|\le ta$ for each leaf $x$ of $T_0'$.  By the inductive hypothesis, $G[\interior_{\mathcal{T}''_0}(x)\cup\boundary_{\mathcal{T}''_0}(x)]$ has a tree decomposition $\mathcal{T}^x:=(B_x:x\in V(T^x))$ of width less than $2(t+1)a$ in which some bag $B_{x_0}$ contains  $\boundary_{\mathcal{T}''_0}(x)$. Create a new tree $T_0$ from $T_0'$ by replacing each leaf $x$ of $T_0'$ with the node $x_0$ from the tree $T^x$ obtained this way.  Then $\mathcal{T}_0:=(B_x:x\in V(T_0))$ is a tree decomposition of $G[Y]$.
  \begin{clm}\label{treewidth_bound}
     The width of $\mathcal{T}_0$ is at most $2(t+1)a$.
  \end{clm}
 
 % \[
 %    B_x:=\begin{cases}
 %    (\boundary_{\mathcal{T}'_0}(x)\cap Y) \cup (\interior_{\mathcal{T}'_0}(x)\cap (W\cup Z))
 %    & \text{if $x$ is a leaf of $T_0$} \\
 %    (B'_x\cap Y) \cup (\interior_{\mathcal{T}'_0}(x)\cap (W\cup Z)) 
 %    & \text{otherwise. }
 %    \end{cases}
 % \]
 % Let $G_0:=G[\bigcup_{x\in V(T_0')} B_x]$ and observe that $V(G_0)\supseteq Z\cup W$ since the root $x_0$ of $T_0'$ has $B_{x_0}\supseteq \interior_{\mathcal{T}'_0}(x_0)\cap (Z\cup W)=Y\cap(Z\cup W)=Z\cup W$.  Let $\mathcal{T}_0:=(B_x:x\in V(T_0'))$.

 % \begin{clm}\label{tree_decomp}
 %     $\mathcal{T}_0$ is a tree decomposition of $G_0$ in which $W\cup Z\subseteq B_{x_0}$ for the some node $x_0$ of $T_0$ and having width less than
 %     \[
 %       \max\{d:\in\{0,\ldots,h\}: \min\{2ta+(d+1)a -1, 2ta\cdot (\tfrac{2}{3})^{d-1} + (4d+1)a\} \} \enspace .
 %     \]
 % \end{clm}

 \begin{clmproof}
    The inductive hypothesis ensures that all bags of the tree decomposition have size at most $(2t+1)a$ except for those associated with non-leaf nodes of $T'_0$.  
    % We will show that, for each $d\in\{0,\ldots,h-1\}$ and each non-leaf node $x$ of $T_0'$ having depth $d$,
    Let $x$ be a non-leaf node in $T_0'$ whose depth is $d<h$. If $d=0$, then 
    \[
      |B_x| \le |W\cup Z| + |B'_x| \le (2ta-1)+a < (2t+1)a \enspace .
    \]
    If $d\ge 1$ then, by \cref{separation_tree}, $|B'_x|\le (d+1)a$ and $|\interior_{\mathcal{T}_0'}(x)|\le |W_\ell|\cdot(\tfrac{2}{3})^{d}$.
    By \cref{cell_bound},
    \[
      |B_x| \le |\interior_{\mathcal{T}_0'}(x)\cap (W\cup Z)| + |B'_x|
      \le 2ta  \cdot (\tfrac{2}{3})^{d-1}+3da + (d+1)a
      \le 2ta\cdot (\tfrac{2}{3})^{d-1}+(4d+1)a \enspace .
    \]
    the right hand side of this equation is less than $(2ta+1)$ for all $d\in\{1,\ldots,h-1\}$.
  \end{clmproof}
  Let $x_0$ be the root of $T_0$. Then $B_{x_0}:=B'_{x_0}\cap Y\supseteq W\cup Z$.  Therefore, $\mathcal{T}_0=(B_x:x\in V(T_0))$ is a tree decomposition of $G[Y]$ that (by \cref{treewidth_bound}) has width less than $(2t+1)a$ and there exists $x_0\in V(T_0)$ such that $W\cup Z\subseteq B_{x_0}$.  This completes the proof. 
\end{proof}


\bibliographystyle{plainurlnat}
\bibliography{dnr}

\end{document}





\section{Preliminaries}


A \defin{flow} $(f,g)$ in a graph $G$ is a pair of functions $f:V(G)^2\to\R_{\ge 0}$ and $g:V(G)\to\R_{\ge 0}$ such that $f(v,w)=0$ for each $vw\not\in E(G)$ and
\begin{equation}
  \sum_{w\in N_G(v)} f(v,w) + g(v) \ge \sum_{w\in N_G(v)} f(w,v)
  \label{conservation_of_flow}
\end{equation}
Any vertex $v\in V(G)$ in which \eqref{conservation_of_flow} does not hold with equality is called an \defin{$\mathcal{F}$-sink}.  The \defin{congestion} of $\mathcal{F}$ at a vertex $v\in V(G)$ is the quantity on the left-hand-side of \eqref{conservation_of_flow}.  The \defin{congestion} of $\mathcal{F}$ is the maximum congestion of $\mathcal{F}$ at any vertex in $G$.  The \defin{total supply} of $\mathcal{F}$ is $\sum_{v\in V(G)} g(v)$.

A \defin{pseudocycle} in a graph $G$ is a sequence of $\ell\ge 2$ vertices $v_0,\ldots,v_{\ell-1}$ of $G$ such that $v_iv_{(i+1)\bmod\ell}\in E(G)$ for each $i\in\{0,\ldots,\ell-1\}$.
Without loss of generality we consider only flows in which, for each pseudocycle $v_0,\ldots,v_{\ell-1}$ of $G$, there exists at least one $i\in\{0,\ldots,\ell-1\}$ such that $f(v_i,v_{(i+1)\bmod\ell})=0$.  (Otherwise, we can reduce $f(v_i,v_{(i+1)\bmod \ell})$ by $\min\{f(v_j,v_{(j+1)\bmod\ell}):j\in\{0,\ldots,\ell-1\}\}$ for each $i\in\{0,\ldots,\ell-1\}$.  Note that this implies that for any edge $vw$ of $G$, at least one of $f(v,w)$ or $f(w,v)$ is equal to $0$.

Any flow $\mathcal{F}:=(f,g)$ in $G$ defines a directed graph $\mathdefin{G_{\mathcal{F}}}$ that includes the directed edge $vw$ if and only if $f(v,w)>0$ and includes a vertex $v$ of $G$ if and only if $g(v)\neq 0$ or there exists an edge $vw$ of $G$ such that $f(v,w)\neq 0$ or $f(w,v)\neq 0$.  A vertex $v$ of $G_\mathcal{F}$ is \defin{$\mathcal{F}$-saturated} if $g(v)=1$, otherwise $v$ is \defin{$\mathcal{F}$-unsaturated}.  By the assumptions of the previous paragraph $G_{\mathcal{F}}$ is always acyclic.

Let $G$ be a graph and let $W$ be a subset of $V(G)$.  A \defin{$W$-cloud} of $G$ is a flow $\mathcal{F}:=(f,g)$ in which $g(v)\le 1$ for each $v\in V(G)$ and the only $\mathcal{F}$-sinks of $G$ are in $W$.  A vertex $v$ of $G_{\mathcal{F}}$ is \defin{$\mathcal{F}$-saturated} if $g(v)=1$. \citet{dvorak.norin:treewidth} make the following observation, which is a  consequence of Menger's Theorem:

\begin{obs}\label{flow_vs_cut}
  For any graph $G$ and any $W\subseteq V(G)$, there exists a $W$-cloud of $G$ with total supply $s$ and congestion at most $\alpha$ if and only if there is no separation $(X,Y)$ of $G$ with $W\subseteq Y$ such that $|Y\setminus X| + \alpha|X\cap Y| < s$.
\end{obs}

The arguments used in the proof of the following lemma are similar to those used by \citet{dvorak.norin:treewidth} in their discussion of strongly $\alpha$-tame $W$-clouds.

\begin{lem}\label{tame_w_cloud}
  If $G$ has a $W$-cloud with total supply $s\ge |W|$ and congestion $\alpha\ge 1$ then $G$ has a $W$-cloud $\mathcal{F}$ with total supply $s$ and congestion at most $\alpha$ in which the number of $\mathcal{F}$-saturated vertices in $G_\mathcal{F}$ is at least $\lfloor|V(G_{\mathcal{F}})|/2\rfloor$.
\end{lem}

\pat{We don't use the assumption $s\ge |W|$ in the proof, but we could use it to show that each vertex in $W$ is saturated.  Let's see if that's helpful later.}

\begin{proof}
  Let $\mathcal{F}$ be a $W$-cloud in $G$ with total supply $s$ and congestion $\alpha$.  Let $\sigma$ be an ordering of the vertices in $G_\mathcal{F}$ in which a vertex $u$ appears before a vertex $v$ if $G_{\mathcal{F}}$ contains a directed path from $u$ to $v$.

  Suppose that $G_{\mathcal{F}}$ contains a vertex that is unsaturated and has in-degree greater than $0$.  Let $w$ be the first such vertex that appears in $\sigma$.

  Since $G_{\mathcal{F}}$ is acyclic, it contains a directed path $v_0,\ldots,v_\ell$ from a vertex $v_0$ with in-degree $0$ to $v_\ell:=w$. Let $\Delta:=\min(\{f(v_{i-1},v_i):i\in\{1,\ldots,\ell\}\}\cup\{(1-g(w))\})$.
  For each $i\in\{1,\ldots,\ell\}$, reduce $f(v_{i-1},v_i)$ by $\Delta$, reduce $g(v_0)$ by $\Delta$, and increase $g(w)$ by $\Delta$.  This does not change the total supply, does not increase the congestion, but
  \begin{enumerate}[nosep,nolistsep]
     \item results in the removal of an edge from $G_\mathcal{F}$ (if $\Delta=f(v_{i-1},v_i)$ for some $i\in\{1,\ldots,\ell\}$); or
     \item makes $w$ a $\mathcal{F}$-saturated vertex and does not increase the number of edges in $G_\mathcal{F}$.
  \end{enumerate}
   In the second case, this operation decreases the number of vertices of $G_{\mathcal{F}}$ that have in-degree $0$ and are not $\mathcal{F}$-saturated.
   By repeating this operation as long as $G_{\mathcal{F}}$ has an vertex with in-degree $0$ that is not $\mathcal{F}$-saturated we eventually obtain a $W$-cloud with total supply $s$ and congestion at most $\alpha$ in which any vertex of $G_{\mathcal{F}}$ that is not $\mathcal{F}$-saturated has in-degree $0$.

\hussein{We might need to add that the flow still reach W in case 1 (what happen in 1 is safe), I will write a small proof. That follows from $w$ being the first unsaturated vertex.}

   Now suppose that $W$ contains two unsaturated vertices $w_1$ and $w_2$. Without loss of generality, assume that $g(u_1)\ge g(u_2)$.  Let $\Delta:=\min\{g(w_2),1-g(w_1)\}$.  Decrease $w_2$ by $\Delta$ and increase $w_1$ by $\Delta$.  This either increases the number of $\mathcal{F}$-saturated vertices in $W$ (if $\Delta=1-g(w_1)$) or decreases the number of vertices in $G_\mathcal{F}$ (if $\Delta=g(w_2)$).  By repeating this operation exhaustively, we obtain a $W$-cloud in which $G_{\mathcal{F}}$ contains at most one vertex of $W$ that is not $\mathcal{F}$-saturated.

   Next, suppose that some $\mathcal{F}$-saturated vertex $v$ of $G_\mathcal{F}$ has two incoming edges $u_1v$ and $u_2v$ and neither $u_1$ nor $u_2$ is $\mathcal{F}$-saturated.  Without loss of generality, suppose that $g(u_1)\le g(u_2)$, and let $\Delta=\min\{1-g(u_1),g(u_2)\}$.  Decrease $g(u_2)$ and $f(u_2,v)$ by $\Delta$ and increase $g(u_1)$ and $f(u1,v)$ by $\Delta$.  This does not change the total supply of $\mathcal{F}$.  It may increase the congestion of $u_1$ but, since $u_1$ has in-degree $0$ in $G_\mathcal{F}$, the congestion at $u_1$ is at most $g(u_1)\le 1\le \alpha$.  Thus, this does not increase the congestion of $\mathcal{F}$.  On the other hand, this either
   \begin{enumerate}[nosep,nolistsep]
     \item results in the removal of a vertex and edge from $G_\mathcal{F}$ (if $\Delta=f(v_{u_2},w)$); or
     \item makes $u_1$ an $\mathcal{F}$-saturated vertex (if $\Delta=1-g(u_1)$) and does not increase the number of vertices in $G_\mathcal{F}$.
  \end{enumerate}
  In the second case, this operation increases the number of vertices of $G_{\mathcal{F}}$ that are $\mathcal{F}$-saturated.  By repeating this operation exhaustively, we obtain a $W$-cloud in which each saturated vertex $v$ in $G_{\mathcal{F}}$ has at most one incoming edge $uv$ in which $u$ is not $\mathcal{F}$-saturated.

   Now, any vertex $u$ of $G_{\mathcal{F}}$ that is not $\mathcal{F}$-saturated is either the unique such vertex in $W$ or has in-degree $0$ and is incident to an edge $uv$ where $v$ is $\mathcal{F}$-saturated. Each $\mathcal{F}$-saturated vertex $v$ is adjacent to at most one such edger $uw$. Therefore, the number of $\mathcal{F}$-saturated vertices in $G_{\mathcal{F}}$ is $k$, then $|V(G)|\le 2k+1$, and $k\ge\lfloor |V(G)|/2\rfloor$.
\end{proof}





% We will use \cref{flow_vs_cut} with $s:=n:=|V(G)|$.  In this setting,
% $|Y\setminus X|=n-|X|$. Thus, the condition $|Y\setminus X|+\alpha|X\cap Y|<s$ becomes $n-|X|+\alpha|X\cap Y|< n$.  Rewriting this inequality yields the following special case of \cref{flow_vs_cut}:

% \begin{obs}\label{flow_vs_cut_n}
%   For any $n$-vertex graph $G$ and any $W\subseteq V(G)$, there exists a $W$-cloud of $G$ with total supply $n$ and congestion at most $\alpha$ if and only if there is no separation $(X,Y)$ of $G$ with $W\subseteq Y$ such that $|X|/|Y\setminus X| > \alpha$.
% \end{obs}

\section{The Proof}

% [TODO: I didn't work out the constants. Think of something like ${C}=100$ and ${c}=10$]

% \hussein{Here, $(A, B)$ intersects $W$, because if it is not, then it contradicts $\alpha$?}
% \pat{$A\cap B$ may or may not intersect $W$.  For example, $W$ might be an independent set, in which case there is no reason $A\cap B$ needs to intersect $W$.}

% \begin{lem}\label{balanced_on_w}
%   Let $\beta >0$,
%   let $n\ge 1/\beta$, let $G$ be an $n$-vertex graph, let $W\subseteq V(G)$, let $(A,B)$ be a balanced separation of $G$ of order $a$, and let $\mathcal{F}$ be a $W$-cloud of $G$ with total supply $n$ and congestion at most $\alpha:=n/(\beta|W|)$.  Then
%   \[
%   \max\{|A\cap W|,|B\cap W|\}\le \left(1-\tfrac{\beta}{3}\right)|W|+2a \enspace .
%   \]
% \end{lem}

% \begin{proof}
%   Let $(f,g):=\mathcal{F}$.  Since the total supply of $\mathcal{F}$ is $n$, $g(v)=1$ for each $v\in V(G)$.  We construct a flow $\mathcal{F}':=(f',g')$ from $\mathcal{F}$ by preventing any flow from entering or leaving vertices in $A\cap B$.  More precisely, $g'(v):=0$, $f'(v,w):=0$, and $f'(w,v):=0$ for each $v\in A\cap B$ and each $w\in N_G(v)$.  \pat{TODO: Explain how to reduce flow on other edges and supply on other vertices to reestablish \eqref{conservation_of_flow}}.

%   Observe that the total supply in $\mathcal{F}'$ is equal to the total supply in $\mathcal{F}$' minus the total congestion at the vertices in $A\cap B$.   Since each vertex in $A\cap B$ has congestion at most $\alpha$, the total supply in $\mathcal{F}'$ is at least $n-\alpha|A\cap B|$.  Since $g'(v)\le g(v)$ for all for $v\in V(G)$, this implies that, for any $S\subseteq V(G)$,
%   \[
%     \sum_{v\in S} g'(v)\ge \sum_{v\in S}g(v) - \alpha|A\cap B| = |S| - \alpha a \enspace .
%   \]

%   Now consider the graph $G_A:=G-B$.  Since $f'(v,w)=0$ for any edge $vw$ of $G$ with an endpoint in $A\cap B$, the $W$-cloud $\mathcal{F}'$ of $G$ induces a $(W-B\usepackage[normalem]{ulem})$ cloud $\mathcal{F}'_A$ in $G_A$.  The total supply of $\mathcal{F}'_A$ is
%   \begin{equation}
%      \sum_{v\in V(G_A)} g'(v) \ge |A\setminus B| -\alpha a \ge \left(\frac{n}{3}-a\right) - \frac{an}{\beta|W|} \label{total_supply_a}
%      % = \left(\frac{C-c}{3C}\right)n - a = \left(\frac{1}{3}-\frac{c}{C}-\frac{a}{n}\right)n
%      % = \left(\frac{1-\epsilon}{3}\right)n
%   \end{equation}

%   Since the congestion of $\mathcal{F}'$ is at most $\alpha$, the congestion of $\mathcal{F}'_A$ is at most $\alpha$.  In particular, the congestion at each vertex of $V(G_A)\cap W$ is at most $\alpha$.  Therefore,
%   \[
%      \frac{n}{\beta|W|} = \alpha =  \ge \frac{\sum_{v\in V(G_A)} g'(v)}{|V(G_A)\cap W|}
%   \]
%   Substituting \cref{total_supply_a} and rewriting this inequality yields
%   \begin{align*}
%     |V(G_A)\cap W|
%     & \ge \left(\left(\frac{n}{3}-a\right)-\frac{an}{\beta|W|}\right)\cdot\frac{\beta|W|}{n} \\
%     & = \frac{\beta|W|}{3} - a\left(1+\frac{\beta|W|}{n}\right) \\
%     & \ge \frac{\beta|W|}{3} - 2a \enspace ,
%   \end{align*}
%   since $|W|\le n$ and $\beta\le 1$.
%   Since $B=V(G)\setminus V(G_A)$,
%   \begin{align*}
%     |B\cap W|
%       & = |(V(G)\cap W)\setminus(V(G_A)\cap W)| \\
%       & = |W|-(V(G_A)\cap W)| \\
%       & \le |W|-\frac{\beta|W|}{3} + 2a \\
%       & = \left(1-\tfrac{\beta}{3}\right)|W| + 2a \enspace . \qedhere
%   \end{align*}
% \end{proof}

\begin{lem}\label{number_lemma}
    Let $W$ and $M$ be positive numbers and
    let $x_1,\ldots,x_r$ be a sequence of positive numbers with $0<x_1\le x_2\le \cdots\le x_r\le M$ and $\sum_{i=1}^r x_i=W$.  Then there exists $j\in\{1,\ldots,r\}$ such that $\sum_{i=1}^j x_i\le \tfrac{1}{2}(W+M)$ and $\sum_{i=j+1}^r x_i\le \tfrac{1}{2}(W+M)$.
\end{lem}

\begin{proof}
  % If $\Delta\ge w$ then the lemma is trivially satisfied by taking $j=r$. Thus, we may assume that $0<\Delta<w$. By the symmetry between $\Delta$ and $w-\Delta$, we may assume without loss of generality, that $\Delta\le w/2$.
  Select the unique $j'\in\{1,\ldots,r\}$ such that $\sum_{i=1}^{j'-1}x_i\le W/2$ and $\sum_{i=j'+1}^r x_i<W/2$.  Then, $\sum_{i=1}^{j'} x_i+\sum_{i=j'}^r x_i = W+ x_{j'}\le W+M$, so $\sum_{i=1}^{j'} x_i\le \tfrac{1}{2}(W+M)$ or $\sum_{i=j'}^{r} x_i\le \tfrac{1}{2}(W+M)$.  In the former case, taking $j=j'$ satisfies the conditions of the lemma.  In the latter case, taking $j=j'-1$ satisfies the conditions of the lemma.
\end{proof}



% \pat{Second Try}
% \noindent \hussein{I think in $A1$, the separation can have order $ar$, but in $A2$ it has order $(a + \Delta)r$.}
\begin{lem}\label{amplifier}
  Let $H$ be a graph with $\sep(H)\le a$ and let $W\subseteq V(H)$. For any integers $r\ge 0$ and $\Delta$ with $\Delta\le |W|/2$, there exists a separation $(P,Q)$ of $H$ such that
  \begin{enumerate}[nosep,nolistsep,label=\rm(A\arabic*),ref=\rm A\arabic*]
    \item\label[p]{splits_w} $|P\cap Q|\le ar$ and $\max\{|(P\setminus Q)\cap W|,|(Q\setminus P)\cap W|\}\le \max\{\tfrac{2}{3}|W|,|W|-\Delta\}$; or
    \item\label[p]{smaller_y} $|P\cap Q|\le ar +\Delta$,  $W\subseteq Q$, and $|Q|\le (\tfrac{2}{3})^r\cdot |V(H)|+ ar + \Delta$.
  \end{enumerate}
\end{lem}

\begin{proof}
  The proof is by induction on $r$. When $r=0$, taking $(P,Q)=(\emptyset,V(H))$ satisfies condition \cref{smaller_y}.  Now assume $r\ge 1$.  Let $(A,B)$ be a balanced separation of $H$ of order at most $a$.  Without loss of generality, suppose $|A\cap W|\le |B\cap W|$.  Since $|(A\setminus B)\cap W|+|(B\setminus A)\cap W|= |W|+|A\cap B\cap W|\le |W|$, we have $|(A\setminus B)\cap W|\le \tfrac{1}{2}|W|< \tfrac{2}{3}|W|$.  If $|(B\setminus A)\cap W|\le |W|-\Delta$, then the separation $(P,Q):=(A,B)$ satisfies \cref{splits_w} and we are done.  We now assume that $|(B\setminus A)\cap W|>|W|-\Delta$.

  Consider the graph $H':=H[B\setminus A]$.  Let $W':=W\setminus A$ and let $\Delta':=\Delta-|A\cap W|$. Notice that $|W'|=|W\setminus A|=|W|-|A\cap W|$. Therefore $\Delta' \le \tfrac{2}{3}|W|-|A\cap W|\le \tfrac{2}{3}(|W|-|A\cap W|)=\tfrac{2}{3}|W'|$.  Therefore, $H'$, $W'$, $\Delta'$, and
  $r':=r-1$ satisfy the conditions on $H$, $W$, $\Delta$, and $r$ (respectively) required to apply the lemma.  By the inductive hypothesis, there exists a separation $(P',Q')$ of $H'$ of order at most $a(r-1)$, which satisfies \cref{splits_w} or \cref{smaller_y} with $H$, $W$, $\Delta$, and $r$ replaced by $H'$, $W'$, $\Delta'$, and $r'$, respectively.

  % Consider the separation $(P,Q):=(A\cup P',Q')$. The order of $(P,Q)$ is
  % \begin{align*}
  %   |P\cap Q| & \le |A\cap Q'|+|P'\cap Q'| \\
  %   & \le |A\cap Q'|+ (a+\Delta)(r-1) \\
  %   & \le |A\cap (B\cup W)|+(a+\Delta)(r-1)\\
  %   & = |A\cap B| + |A\cap (W\setminus B)|+(a+\Delta)(r-1)\\
  %   & = |A\cap B| + |W\setminus B|+(a+\Delta)(r-1)\\
  %   & \le (a+\Delta)r \enspace .
  % \end{align*}


  First suppose that $(P',Q')$ satisfies \cref{splits_w}. Let $S:=(A\cap B)\cup (P'\cap Q')$.  Then $|S|= |A\cap B|+|P'\cap Q'|\le a + a(r-1)=ar$.    We now argue that, for each component $C$ of $H-S$,  $|V(C)\cap W|\le \max\{\tfrac{2}{3}|W|,|W|-\Delta\}$.  Since $C$ contains no vertex in $S\supseteq A\cap B$, it must be that  $V(C)\subseteq A\setminus B$ or that $V(C)\subseteq B\setminus A$.  In the former case, $|V(C)\cap W|\le |(A\setminus B)\cap W|=|W|-|B\cap W|<\Delta\le\max\{\tfrac{2}{3}|W|,|W|-\Delta\}$, since $|B\cap W|\ge |(B\setminus A)\cap W|> |W|-\Delta$.  In the latter case, since $C$ contains no vertex in $S\supseteq P'\cap Q'$, it must be that $V(C)\subseteq P'\setminus Q'$ or that $V(C)\subseteq Q'\setminus P'$.  In either case, \cref{splits_w} implies that
  \begin{align*}
    |V(C)\cap W| = |V(C)\cap W'|
      & \le \max\{\tfrac{2}{3}|W'|,|W'|-\Delta'\} \\
      & \le \max\{\tfrac{2}{3}|W|,|W'|-\Delta'\} \\
      & = \max\{\tfrac{2}{3}|W|,|W|-|A\cap W|-(\Delta-|A\cap W|)\} \\
      & = \max\{\tfrac{2}{3}|W|,|W|-\Delta\} \enspace .
  \end{align*}.

  We first deal with an easy extreme case: Suppose that $|V(C)\cap W| \ge \tfrac{1}{3}|W|$ for some component $C$ of $H-S$. In this case, set $P:=V(C)\cup S$ and $Q:=B\setminus V(C)$.  Then $|(P\setminus Q)\cap W|= |V(C)\cap W|\le \max\{\tfrac{2}{3}|W|,|W|-\Delta\}$ and $|(Q\setminus P)\cap W| = |W|-|P\cap W|\le \tfrac{2}{3}|W|$.  Thus, the separation $(P,Q)$ satisfies \cref{splits_w}.  We now assume that $|V(C)\cap W|\le\tfrac{1}{3}|W|$, for each component $C$ of $H-S$.

  Applying \cref{number_lemma}, with $M:=\tfrac{1}{3}|W|$ (and $W:=|W|$), the components of $H-S$ can be partitioned into two sets $X$ and $Y$ such that $\sum_{C\in X} |V(C)\cap W|\le \tfrac{1}{2}(|W|+M)=\tfrac{2}{3}|W|$ and  $\sum_{C\in Y} |V(C)\cap W|\le \tfrac{1}{2}(|W|+M)=\tfrac{2}{3}|W|$.  Therefore, taking $P:=S\cup\bigcup_{C\in X}V(C)$ and $Q:=S\cup\bigcup_{C\in Y} V(C)$ gives a separation $(P,Q)$ that satisfies \cref{splits_w}.

  Next, suppose that $(P',Q')$ satisfies \cref{smaller_y}. Let $S:=(A\cap B)\cup (A\cap W)\cup  (P'\cap Q')$.  Then
  \begin{align*}
    |S| & = |A\cap B|+|(A\setminus B)\cap W|+|P'\cap Q'|\\
      & \le a + |A\cap W| + a(r-1)+\Delta' \\
      & = ar + \Delta \enspace .
  \end{align*}
  Consider the separation $(P,Q):=(A\cup P',Q'\cup(A\cap B)\cup (A\cap W))$. We now show that $(P,Q)$ satisfies the three conditions of \cref{smaller_y}.
  First, observe that $P\cap Q=S$, so $|P\cap Q|=|S|\le (a+\Delta)r$.  By the inductive hypothesis, $W'=B\cap W\subseteq Q'$. Therefore $W=W'\cup (A\cap W)\subseteq Q$.  Finally, observe that $|V(H')|=|B\setminus A|\le \tfrac{2}{3}|V(H)|$.  Therefore,
  \begin{align*}
     |Q|& =|Q'\cup(A\cap B)\cup (A\cap W)| \\
      & \le |Q'|+|A\cap B|+|A\cap W| \\
      & \le (\tfrac{2}{3})^{r-1}\cdot|V(H')| + a(r-1) + \Delta' + |A\cap B|+ |A\cap W| \\
      & = (\tfrac{2}{3})^{r}\cdot|V(H)| + ar + \Delta \enspace .
  \end{align*}
  Therefore, $(P,Q)$ satisfies \cref{smaller_y}.
\end{proof}


\begin{lem}
  Let $a\ge 1$ be an integer and let $G$ be a graph with $\sep(G)\le a$.  For any $W\subseteq V(G)$, at least one of the following is true:
  \begin{enumerate}[nosep,nolistsep,label=(\alph*),ref=\alph*]
    \item\label[p]{small_w} $|W|\le c_1a$\todo{$c_1\gg 1$};
    \item\label[p]{small_y} $G$ has a separation $(X,Y)$ with $|X\cap Y|\le c_1a$, $W\subseteq Y$, and $|Y|\le c_3 a$\todo{$c_3\ge c_1$}; or
    \item\label[p]{balances_w} $G$ has a separation $(A,B)$ such that $|A\cap (B\cup W)|<|W|$ and $|B\cap (A\cup W)|< |W|$.
  \end{enumerate}
\end{lem}

\begin{proof}
  We may assume that $|W|>c_1a$, otherwise \cref{small_w} holds and there is nothing to prove. Let $(X,Y)$ be a separation of $G$ such that
  \begin{enumerate}[nosep,nolistsep,label=(\roman*),ref=\roman*]
      \item\label[p]{has_w} $W\subseteq Y$;
      \item\label[p]{small_order} $|X\cap Y|\le c_6a$;\todo{$0<c_6<c_1$} and
      \item\label[p]{minimal_size} $|Y\setminus X|$ is minimum (among all separations that satisfy \cref{has_w} and \cref{small_order}).
  \end{enumerate}
  The separation $(X,Y)$ is well-defined because the separation $(\emptyset,V(G))$ satisfies \cref{has_w} and \cref{small_order}.  Note that, if $|V(G)|\ge c_6a$, then then $|X\cap Y|=c_6\cdot a$ since, otherwise, $|Y\setminus X|$ can be reduced by adding any element of $Y\setminus X$ to $X$.

  If $|Y|\le c_3a$ then $(X,Y)$ satisfies \cref{small_y} and there is nothing more to prove.  Now assume that $|Y|> c_3a$. Let\todo{$c_7,c_8\gg 1$\newline $c_8\ge c_1$}
  \[
      s:=c_7|Y\setminus X|\text{ and let }\alpha:=\frac{\beta \cdot (c_7-1)|Y\setminus X|}{c_6\cdot a}\enspace.
  \]
  % Note that $|Y\setminus X|= |Y|-|Y\cap X|\ge (c_3-c_6)a$, so
  % \[
  %    \alpha \ge \frac{c_8\cdot c_7\cdot(c_3-c_6)}{c_1\cdot c_6} \mathcolor{red}{\ge 1} \enspace . \\
  % \]
  \todo{$\beta$ will be around $3$, I think}
  Our intention is to use \cref{flow_vs_cut} with the parameters $s$ and $\alpha$. We first deal with the case in which $G$ has no $W$-cloud with total supply $s$ and congestion at most $\alpha$.

  Suppose that $G$ has a separation $(X',Y')$ with $W\subseteq Y'$ and
  \begin{equation}
    \alpha |X'\cap Y'|+|Y'\setminus X'|< s \enspace . \label{bottleneck}
  \end{equation}
  Note that this implies that
  \[
     |X'\cap Y'|\le \frac{s}{\alpha}=\frac{c_7\cdot c_6\cdot a}{\beta\cdot (c_7-1)} < c_6\cdot a \enspace .
  \]
  This immediately implies that $|Y'\setminus X'|>|Y\setminus X|$ since, otherwise, $(X',Y')$ would contradict the choice of $(X,Y)$.
  This inequality can be rewritten as
  \begin{align*}
    |X'\cap Y'|
      & \le \frac{s-|Y'\setminus X'|}{\alpha} \\
      & = \frac{c_7\cdot c_6 \cdot a}{\beta\cdot(c_7-1)} - \frac{c_6\cdot a\cdot|Y'\setminus X'|}{\beta\cdot (c_7-1)\cdot|Y\setminus X|} \\
      & = \frac{c_7\cdot c_6 \cdot a}{\beta\cdot(c_7-1)} - \frac{c_6\cdot a\cdot|Y\setminus X|}{\beta\cdot (c_7-1)\cdot|Y\setminus X|} \\
      & = \frac{c_6\cdot a}{\beta} \enspace .
  \end{align*}
  Let $H:=G[Y']$ and observe that $W\subseteq V(H)$.
  Apply \cref{amplifier} to $H$ to obtain a separation $(P,Q)$ that satisfies condition \cref{splits_w} or condition \cref{smaller_y} with the value $\Delta=\delta\cdot a$ and a value $r$ that satisfies:
  \[
     \frac{c_6}{\beta} + r \le \delta \le (1-\tfrac{1}{\beta})c_6 - r
  \]

  First suppose that $(P,Q)$ satisfies \cref{smaller_y}.  We will show that, in this case, the separation $(X^\star,Y^\star):=(X'\cup P,Q)$ contradicts the choice of $(X,Y)$. By \cref{smaller_y} we have
  \begin{align*}
    |Q| & \le (\tfrac{2}{3})^r\cdot |V(H)| + ar + \Delta \\
    & = (\tfrac{2}{3})^r\cdot |Y'| + (r+\delta)a \\
    & \le (\tfrac{2}{3})^r\cdot (|Y'\setminus X'|+|X'\cap Y'|) + (r+\delta)a \\
    & \le (\tfrac{2}{3})^r\cdot (|Y'\setminus X'|+\alpha|X'\cap Y'|) + (r+\delta)a & \mathcolor{red}{\text{(provided that $\alpha \ge 1$)}} \\
    & < (\tfrac{2}{3})^r\cdot s + (r+\delta)a \\
    & = (\tfrac{2}{3})^r\cdot c_7\cdot |Y\setminus X| + (r+\delta)a \\
    & \le (\tfrac{2}{3})^r\cdot c_7\cdot |Y\setminus X| + (r+\delta)a \\
    & = |Y\setminus X|-(1-(\tfrac{2}{3})^r)\cdot |Y\setminus X| + (r+\delta)a \\
    & \le |Y\setminus X|-(1-(\tfrac{2}{3})^r)c_6 a + (r+\delta) a
    \mathcolor{red}{{}< |Y\setminus X|} \enspace .
  \end{align*}
  \textcolor{red}{provided that $(1-(\tfrac{2}{3})^r)\cdot (c_3-c_6) a > ar + \Delta$.}
  The separation $(X^\star,Y^\star)$ has order

  \begin{align*}
    |X^\star\cap Y^\star|
      & = |(X'\cup P)\cap Q| \\
      & \le |X'\cap Q| + |P\cap Q| \\
      & \le |X'\cap Y'| + |P\cap Q| & \text{(since $Q\subseteq V(H)=Y'$)}\\
      & \le \frac{c_6\cdot a}{\beta} + (r+\delta)a \\
      & = (\tfrac{c_6}{\beta} + r+\delta)a \\
      & \mathcolor{red}{\le c_6\cdot a}  \enspace .
  \end{align*}
  Thus $(X^\star,Y^\star)$ is a separation of $G$ with $W\subseteq Y^\star$, $|X^\star\cap Y^\star|\le c_6\cdot a$ and $|Y^\star|=|Q|<|Y|$, which contradicts the choice of $(X,Y)$.  We conclude that $(P,Q)$ must satisfy outcome \cref{splits_w} of \cref{amplifier}.

  We will now show that the separation $(A,B):=(X'\cup P,Q)$ satisfies \cref{balances_w}.  This separation has order
  \begin{align*}
    |A\cap B|
    & = |(X'\cup P)\cap Q)| \\
    & \le |X'\cap Q|+|P\cap Q| \\
    & \le |X'\cap Y'| + |P\cap Q| \\
    & \le \frac{c_6\cdot a}{\beta} + ar \\
    & = \left(\frac{c_6}{\beta} + r\right)a \enspace .\\
    % & \mathcolor{purple}{= \left(\frac{c_1\cdot c_6}{c_8} + r\right)a}
  \end{align*}
  Therefore,
  % \hussein{The separation $(P, Q)$ separates $W$, into two sides $W_p$ and $W_q$, where $|W_q| \leq |W| - \Delta$, and $|W_p| \leq \frac{1}{2}|W| + (a+ \Delta)r$, so each of them will give us different inequalities. One of these is the big side, and we want its size combined with $A\cap B$ to be less $|W|$! }
  \begin{align*}
    |A\cap (B\cup W)|
    & \le |A\cap B| + |A\cap W|\\
    & < \left(\frac{c_6}{\beta} + r\right)a + |W| - \Delta \\
    & = \left(\frac{c_6}{\beta} + r-\delta \right)a + |W| \\
    % & = \left(\frac{c_1\cdot c_6}{c_8} + r\right)a + |W| - \Delta \\
    % & \mathcolor{purple}{\le \left(\frac{c_1\cdot c_6}{c_8} + r\right)a + |W| - \Delta} \\
    & \le |W|
    % & = |(X\cup X'\cup P)\cap (Q\cap Y)| \\
    % & \le |X\cap Y|+|X'\cap Q|+|P\cap Q| \\
    % & \le |X\cap Y| + |X'\cap Y'| + |P\cap Q| \\
    % & \le c_6\cdot a + \frac{c_1\cdot c_6\cdot a}{c_8} + ar \enspace .
  \end{align*}
  Furthermore,
    \begin{align*}
        |B\cap (A\cup W)|
        & \le |A\cap B| + |B\cap W|\\
        & = |A\cap B| + |Q\cap W|\\
        & < \left(\frac{c_6}{\beta} + r\right)a + \max\{\tfrac{2}{3}|W|,|W| - \Delta\} \\
        & = \left(\frac{c_6}{\beta} + r + \delta\right)a + |W| \\
        % & = \left(\frac{c_6}{\beta} + r\right)a + |W| - \Delta \\
        &\le |W| \enspace .
  \end{align*}
  Therefore, $(A,B)$ satisfies \cref{balances_w}.

  Finally, we are left with the case in which $G$ does not contain a separation $(X',Y')$ with $W\subseteq Y'$ and $\alpha|X'\cap Y'|+|Y'\setminus X'|<s$.  In this case, \cref{flow_vs_cut} implies that $G$ has a $W$-cloud $\mathcal{F}:=(f,g)$ with total supply $s$ and congestion at most $\alpha$.

  % Modify the flow $\mathcal{F}$ by setting $f(v,w):=0$ for each $v\in X\cap Y$ and call the resulting flow $\mathcal{F}'$.  In this modified flow, the vertices in $X\cap Y$ are sinks, which consume at most $\alpha|X\cap Y|=\alpha \cdot c_6\cdot a$ of the total flow.  In $\mathcal{F}'$, the amount of flow consumed by the sinks in $W\setminus X$ is at least $s':=s-\alpha \cdot c_6\cdot a$.  Let $(A',B')$ be a balanced separation of $G[Y]$\todo{Maybe $G[Y\setminus X]$ is a better option} having order at most $a$.  Modify the flow $\mathcal{F}'$ by setting $f(v,w):=0$ for each $v\in A'\cap B'$ and call the resulting flow $\mathcal{F}''$.  In $\mathcal{F}''$, the amount of flow consumed by vertices in $A'\cap B'$ is at most $\alpha\cdot a$.  Therefore, the amount of flow consumed by vertices in $W\setminus (A'\cap B')$ is at least $s'':=s'-\alpha\cdot a$.
  % The amount of flow in $\mathcal{F}''$ supplied by the vertices in $A'$ is at most $|A'|$.  Therefore, the amount of flow supplied by vertices in $B'\setminus A'$ that is consumed by vertices in $W\setminus ((A\cap B)\cup(X\cap Y))$ is at least
  % \begin{align*}
  %    s_{B'} & := s'' - |A'|  \\
  %    & = s-(\alpha a \cdot (c_6+1) + |A'|) \\
  %    & = |Y|-(\alpha a \cdot (c_6+1) + |A'|) \\
  %    & = |B'\setminus A'|-((\alpha a \cdot (c_6+1) + |A'|) \\
  %    & \ge |B'|-((\alpha a \cdot (c_6+2) \\
  %    & \ge \tfrac{1}{3}|Y|-\alpha a \cdot (c_6+2) \\
  %    & = \tfrac{1}{3}s-\alpha a \cdot (c_6+2)
  % \end{align*}
  % All of this flow is consumed by vertices in $W\setminus A'$.  Since the flow $\mathcal{F}''$ has congestion at most $\alpha$, we have $\alpha|W\setminus A'| \ge s_{B'}$ and rewriting this gives
  % \begin{align*}
  %    |W\setminus A'|
  %      & \ge \frac{s_{B'}}{\alpha} \\
  %      & \ge \frac{\tfrac{1}{3}s-\alpha a \cdot (c_6+2)}{\alpha} \\
  %      & \ge \frac{c_1\cdot a}{3\cdot c_8} - a \cdot (c_6+2)
  % \end{align*}
  % DAMN. Stuck here.

  Let $n:=|V(G_{\mathcal{F}})|$.  By \cref{tame_w_cloud}, we may assume that at least $\lfloor n/2\rfloor$ vertices of  $G_{\mathcal{F}}$ are $\mathcal{F}$-saturated.
  % Therefore $\floor n/2\rfloor\le s$. The remaining $\lceil n/2\rceil$ vertices contribute less than $\lceil n/2\rceil$ to the total supply of $\mathcal{F}$.
  Since $s=\sum_{v\in V(G_{\mathcal{F}})} g(v)\le \sum_{v\in V(G_{\mathcal{F}})} 1=n$, we have $\lfloor n/2\rfloor \ge (n-1)/2 \ge (s-1)/2$.  Therefore, by removing unsaturated vertices from $\mathcal{F}$ we obtain a $W$-cloud $\mathcal{F}':=(f',g')$ with total supply $s'\ge(s-1)/2$ and congestion at most $\alpha$ in which all vertices are saturated.
  % Let $n'=s'$ be the number of vertices in $G_{\mathcal{F}'}$.
  Then\pat{I'm cheating here. I dropped the $-1/2$} \hussein{If every saturated vertex has at most 1 hungry in neighbour, then let $sat(F)$ be the set of saturated vertices, and $unsat(F)$ the hungry ones. we have $|sat(F)| \geq |unsat(F)|$, let $s' := \sum_{v \in sat(F)} g(v)$, we have $s' + \sum_{v \in unsat(F)} g(v)= s$, since $s' = |sat(F)| \geq |unsat(F)| > \sum_{v \in unsat(F)} g(v)$, we have $2s' > s$, consquently $s' > s/2$.}
  \begin{align*}
     s' & \ge s/2 \\
        & = \frac{c_7\cdot|Y\setminus X|}{2}
  \end{align*}
  % Since all vertices in $G_{\mathcal{F}'}$ are $\mathcal{F}'$-saturated the total supply in $\mathcal{F}'$ is an integer, so the total supply of $.

  Consider the graph $G':=G[V(G_{\mathcal{F}'})\cup (Y\setminus X)]$.  Let $n':=|V(G')|$ be the number of vertices of $G'$.  Then,
  \hussein{$s' = |V(G_{\mathcal{F}'})|$ because $d(v) = 1, v \in V(G_{\mathcal{F}'})$.}
  \begin{align*}
     n' & = |V(G_{\mathcal{F}'})\cup (Y\setminus X)| \\
        & = |V(G_{\mathcal{F}'})| + |Y\setminus X\setminus V(G_{\mathcal{F}'})| \\
        & = s' + |Y\setminus X\setminus V(G_{\mathcal{F}'})| \\
        % & = s' + |Y\setminus X| \\
        % & = s' + s/c_7 \\
        % & \le s' + 2s'/c_7 \\
        % & = (1+2/c_7)s' \enspace .
  \end{align*}
  Let $(A',B')$ be a balanced separation of $G'$ of order at most $a$. Then, $|A'|\ge n' - |B'\setminus A'|\ge \tfrac{1}{3}n'$.  In $\mathcal{F}'$, the total supply $\sum_{v\in A'}g'(v)$ originating at vertices in $A'$ is at least:
  \begin{align*}
    |A'\cap V(G_{\mathcal{F}'})|
    & = |A'| - |(A'\setminus V(G_{\mathcal{F}'})| \\
    & \ge |A'| - |Y\setminus X| \\
    & \ge |A'| - |Y\setminus X| \\
    & = |A'| - |A'\cap (Y\setminus X\setminus V(G_{\mathcal{F}'})| \\
    & \ge |A'| - |Y\setminus X\setminus V(G_{\mathcal{F}'})| \\
    & \ge \tfrac{1}{3}n' - |Y\setminus X\setminus V(G_{\mathcal{F}'})| \\
    & = \tfrac{1}{3}s' - \tfrac{2}{3}|Y\setminus X\setminus V(G_{\mathcal{F}'})| \\
    & \ge \tfrac{1}{3}s' - \tfrac{2}{3}|Y\setminus X| \\
    & \ge \frac{c_7\cdot|Y\setminus X|}{6} - \tfrac{2}{3}|Y\setminus X| \\
    & = \frac{(c_7-4)\cdot |Y\setminus X|}{6} \\
  \end{align*}
  Construct a flow $\mathcal{F}'':=(f'',g'')$ from $\mathcal{F}'$ in which each vertex $v$ in $A'\cap B'$ is a sink.  We do this by setting $f''(v,w)=0$ for each vertex $v$ in $A'\cap B'$ and each $w\in N_{G'}(w)$, and reducing flows on other edges in order to satisfy \eqref{conservation_of_flow}.  For each edge $vw$ of $G$, $f''(v,w)\le f'(v,w)\le f(v,w)$. Therefore, the congestion of $\mathcal{F}''$ is at most the congestion of $\mathcal{F}$, which is at most $\alpha$.  Therefore, the sinks of $\mathcal{F}''$ in $A'\cap B'$ consume\todo{define consume} at most $\alpha|A'\cap B'|\le \alpha a$. Therefore, in $\mathcal{F}''$, the total supply originating at vertices in $A'$ that is consumed by vertices in $(A'\setminus B')\cap W$ is at least
  \[
    |A'\cap V(G_{\mathcal{F}'})| - \alpha a
    \ge \frac{(c_7-4)\cdot |Y\setminus X|}{6} - \alpha a
  \]
  Since the congestion of $\mathcal{F}''$ is at most $\alpha$, each vertex in $A'\cap W$ consumes at most $\alpha$, so
\hussein{the left hand-side is the flow towards $W \cap A'\setminus B'$ generated by vertices in $A'$.}
  \[
    \frac{(c_7-4)\cdot |Y\setminus X|}{6} - \alpha a \le \alpha\cdot|(A'\setminus B')\cap W| \enspace .
  \]
  Rewriting this gives
  \begin{align*}
   |(A'\setminus B')\cap W|
    & \ge \frac{(c_7-4)\cdot |Y\setminus X|}{6\alpha} - a \\
    & = \left(\frac{(c_7-4)\cdot c_6}{6\beta(c_7-1)} - 1\right) a \\
    & ............. \\
    % & \mathcolor{purple}{\ge \frac{(c_7-4)\cdot |Y\setminus X|}{6 \cdot \frac{c_8 \cdot s}{c_1 \cdot c_6 \cdot a}} - a}\\
    % & \mathcolor{purple}{\ge \frac{(c_7-4)\cdot |Y\setminus X| \cdot c_1 \cdot c_6}{6 \cdot c_8 \cdot s}a - a} \\
    % & \text{-> replace s by } c_7\cdot |Y\setminus X|\\
    % & \mathcolor{purple}{\ge \frac{(c_7-4)\cdot |Y\setminus X| \cdot c_1 \cdot c_6}{6 \cdot c_8 \cdot c_7 \cdot |Y \setminus X|}a - a}\\
    % & \text{-> simplify}\\
    % & \mathcolor{purple}{\ge \frac{(c_7-4) \cdot c_1 \cdot c_6}{6 \cdot c_8 \cdot c_7}a - a} \\
    % & \mathcolor{red}{\ge \left(\frac{(c_7-4) \cdot c_1 \cdot c_6}{6 \cdot c_8 \cdot c_7} - 1\right)a}\\
    % & = \left(\frac{(c_7-4)\cdot c_1\cdot c_6\cdot|Y\setminus X|-1}{6\cdot c_8\cdot s}\right)a \\
    % & = \left(\frac{(c_7-4)\cdot c_1\cdot c_6-1}{6\cdot c_8\cdot c_7}\right)a
  \end{align*}
  % Therefore,
  % \begin{align*}
  %  |(B'\setminus A')\cap W|
  %   & = |W|-|A'\cap W| \\
  %   & \le |W|- \left(\frac{(c_7-4)\cdot c_1\cdot c_6-1}{6\cdot c_8\cdot c_7}\right)a \enspace .
  % \end{align*}
  The preceding argument shows that, (for very large $c_7$), $B'$ avoids roughly $(c_6/6\beta)a$ elements of $W$.  This is not good enough, because it only shows that combining $(X,Y)$ with $(A',B')$ will produce a separation of order at most $(X\cap Y)+(A'\cap B')-(c_6/6\beta)a = (1-1/6\beta)c_6+c_1> c_1$.  However, we can also study what the separation $(A',B')$ does to $X\cap Y$.  Note that at most $|Y\setminus X|$ units of flow are generated by vertices in $Y\setminus X$.  Therefore, at least $(c_7-1)|Y\setminus X|$ units of flow are generated by vertices in $X$.  All of this flow passes through the $c_6 a$ vertices in $X\cap Y$.  Arguing just like we do above, we can show that
  \hussein{Not if I understood the problem here, but we only need at most half of $X\cap Y$. Because if $(A',B')$ are nested in $G(F)$, we just need $(A',B')$(this is the best case.) The worst case if $(A',B')$ and $(X, Y)$ are crossed. then, $(A',B')$ splits $X \cap Y$ into two halves which we need the minimum to disconnect $G$... I can also argue that every vertex in saturated, if $\alpha \in \mathbb{N}$.}

  \hussein{But, I am still worried about $\alpha \cdot |W|$ being greater than $s$!!}
  \hussein{I repeated the calculation above on paper with my own assumption, and it still not enough!!
  $c_1 - \frac{1}{3\beta}c_6 + \frac{1}{2}c_6>c_1.$}
\hussein{}

  \begin{align*}
    |(A'\setminus B')\cap (X\cap Y)|
    & \ge \frac{(c_7-5)\cdot |Y\setminus X|}{6\alpha} \\
    & = \left(\frac{(c_7-5)\cdot c_6}{6\beta(c_7-1)}-1\right)a
  \end{align*}
  Now, take $c_7$ to be huge, so that $(c_7-5)/(c_7-1)\approx 1$.
  Let $S:=(X\cap Y)\cup (A'\cap B')$.  Consider some component $C$ of $G-S$:
  \begin{itemize}
    \item If $V(C)\subseteq X$, then $N_G(V(C))$ contains at most $c_6 a$ elements from $X\cap Y$, at most $a$ elements from $(A'\cap B')\setminus (X\cap Y)$ and no elements from $W\setminus (X\cap Y)$.

    \item If $V(C)\subseteq Y\cap B'$, then $N_G(V(C))$ contains at most $(1-1/6\beta) c_6a$ elements of $X\cap Y$ and at most $c_1a - c_6a/\beta$ elements of $W$.  This still isn't good enough, but I think it gives us a chance.  The flow $\mathcal{F}''$ is obtained by splitting $\mathcal{F}'$ into a part contained in $A'\setminus B'$ and another part contained in $B'\setminus A'$.  I'm hoping that we can repeat this recursively on these two flows.  After $r$ steps, we should have parts that are adjacent to $(1-1/6\beta)^r c_6a$ vertices in $X\cap Y$ and that are adjacent to $c_1-rc_6a/6\beta$ vertices in $W$ and adjacent to $ar$ vertices in the separator we're building. .......
  \end{itemize}


  Therefore,

  \hussein{the last term should be $|(A'\setminus B' )\cap W|$. right? But the second line, I think it is correct.}
  \begin{align*}
    |B'\cap (A'\cup W)|
    & =  |B'\cap A'| + |W|-|(B'\cap A')\cap W|-|(B'\setminus A')\cap W| \\
    & =  |B'\cap A'| + |W|-|A'\cap W| \\
    & \mathcolor{red}{= |W| + a - |A' \cap W|}\\
    & \le |W| +  \left( \mathcolor{red}{1} - \frac{(c_7-4)\cdot c_1\cdot c_6-1}{6\cdot c_8\cdot c_7}\right)a \\
    & \le |W| +  \left( \mathcolor{red}{1} - \frac{(c_7-4)\cdot c_1\cdot c_6}{6\cdot c_8\cdot c_7}  \mathcolor{purple}{+1}\right)a \\
    & \le |W| +  \left( 2 - \frac{(c_7-4)\cdot c_1\cdot c_6}{6\cdot c_8\cdot c_7} \right)a \\
    & \mathcolor{red}{\le |W|-c_6\cdot a}
  \end{align*}
\hussein{I added plus $a = |A'\cap B'|$. (the red line), I might be wrong!}

  A symmetric argument shows the same bound for $|A'\cap (B'\cup W)|$.

  Finally, consider the separation $(A,B):=(X\cup A',B'\cap Y)$. Then
  \begin{align*}
    |A\cap (B\cup W)|
    & = |(X\cup A')\cap ((B'\cap Y)\cup W)| \\
    & \le |X\cap Y| + |A'\cap (B'\cup W)|\\
    & \le c_6\cdot a + |W| - c_6\cdot a = |W| \enspace .
    % |B'\cap (A'\cup W)|
    % & =  |B'\cap A'| + |W|-|(B'\cap A')\cap W|-|(B'\setminus A')\cap W| \\
    % & =  |B'\cap A'| + |W|-|A'\cap W| \\
    % & \le |W|- \left(\frac{(c_7-4)\cdot c_1\cdot c_6-1}{6\cdot c_8\cdot c_7}\right)a \enspace .
  \end{align*}
  and
  \begin{align*}
    |B\cap (A\cup W)|
    & = |(B'\cap Y)\cap (X\cup A')| \\
    & \le |Y\cap X| + |B'\cap A'| \\
    & \le c_6\cdot a + a \\
    & \le \mathcolor{red}{|W|}
  \end{align*}
  Therefore, the separation $(A,B)$ satisfies \cref{balances_w}.
\end{proof}

\section{On computing the Constants}
We have to chose $\Delta$ satisfying the following inequalities.
\begin{align*}
    \frac{c_1\cdot c_6 \cdot a}{c_8} + (a + \Delta)r \leq c_6 a \\
    \Delta r \leq c_6a - \frac{c_1\cdot c_6 \cdot a}{c_8} - ar\\
    \Delta \leq \frac{c_6\cdot a}{r} - \frac{c_1\cdot c_6 \cdot a}{c_8 \cdot r} - a
\end{align*}
We also can find a lower bound on $\Delta$.

\begin{align*}
     \left(c_6 + \frac{c_1\cdot c_6}{c_8} + r\right)a + |W| - \Delta \le |W|\\
     \left(c_6 + \frac{c_1\cdot c_6}{c_8} + r\right) a  \leq \Delta \\
    c_6 \cdot a + \frac{c_1 \cdot c_6}{c_8} a + ra \leq \Delta
\end{align*}
Thus, $\Delta$ must satisfies the followings at the same time.
\begin{equation}
c_6 \cdot a + \frac{c_1 \cdot c_6}{c_8} a + ra \leq \Delta \leq \frac{c_6\cdot a}{r} - \frac{c_1\cdot c_6 \cdot a}{c_8 \cdot r} - a
\end{equation}

\begin{equation}
\mathcolor{red}{\frac{c_1 \cdot c_6}{c_8} a} + ra \leq \Delta \leq \frac{c_6\cdot a}{r} - \frac{c_1\cdot c_6 \cdot a}{c_8 \cdot r} - a
\end{equation}


let $c' = \frac{c_1 \cdot c_6}{ c_ 8}$,
$$c_6 \cdot a + c'a + ra \leq \Delta \leq \frac{c_6 \cdot a}{r} + \frac{c'\cdot a}{r} - a \leq c_6a + c'a - a$$
Which is a contradiction since $r > 0$.
Note that the upper bound comes from the change of $ar$ to $(a + \Delta)r$ in Lemma 4.

\subsection*{Constraint on $c_8$}
We want to satisfy this constraint.
\begin{align*}
|W| +  \left( 2 - \frac{(c_7-4)\cdot c_1\cdot c_6}{6\cdot c_8\cdot c_7} \right)a  & \mathcolor{red}{\le |W|-c_6\cdot a}\\
\left( 2 - \frac{(c_7-4)\cdot c_1\cdot c_6}{6\cdot c_8\cdot c_7} \right)a
     & \mathcolor{red}{\le -c_6\cdot a}\\
\left( 2 - \frac{(c_7-4)\cdot c_1\cdot c_6}{6\cdot c_8\cdot c_7} \right)
     &\mathcolor{red}{\le -c_6}\\
2 &\leq \frac{(c_7-4)\cdot c_1\cdot c_6}{6\cdot c_8\cdot c_7} - c_6\\
2 &\leq \left(\frac{(c_7-4)\cdot c_1}{6\cdot c_8\cdot c_7} - 1\right) c_6
\end{align*}
The coefficient of $c_6$ must be positive,
\begin{align*}
    0 & < \frac{(c_7-4)\cdot c_1}{6\cdot c_8\cdot c_7} - 1\\
    1 & < \frac{(c_7-4)\cdot c_1}{6\cdot c_8\cdot c_7}
\end{align*}
As $c_8 \geq c_1$ this is false. \hussein{I think the idea is right, but I am missing something!}
\subsection{An attempt to Fix the problem above!}
\hussein{I think the upper bound on $s'$ is not precise!! I have to think about it.}

We started with a flow $\mathcal{F}$ with these parameters:
$$s = c_7 |Y \setminus X| \quad \quad \alpha=\frac{c_8 \cdot s}{c_1 \cdot c_6 \cdot a}.$$
Then, we constructed a flow $\mathcal{F}'$ with total supply $s'$ and congestion $\alpha$. \hussein{Here, I know $s' \geq c_7/2 |Y\setminus X|$, but maybe I can say, I will remove vertices from $G_{\mathcal{F}'}$ to attain this bound.}
$$s' = \frac{c_7}{2} |Y \setminus X|.$$
Let $G_{\mathcal{F}'}$ be the graph induced on the vertices of $G$ with positive demand ($d(v) = 1, v\in V(G)$). We have,
$$|G_{\mathcal{F}'}| = \frac{c_7}{2}|Y \setminus X|$$
Now, we consider the subgraph $G' = G[V(G_{\mathcal{F}'})\cup (Y\setminus X)].$ we have
$$n' := |V(G')| \leq s' + |Y \setminus X| = \frac{c_7}{2}|Y \setminus X| + |Y \setminus X|.$$
Consider a balanced separation $(A', B')$ of $G'$ with order at most $a$. Since $(A', B')$ is balanced, we have
$$|A'\setminus B'| \leq \frac{2}{3} n' \quad \text{ and } \quad |B'\setminus A'| \leq \frac{2}{3}n'$$
\hussein{I believe $(A', B')$ split $W$ into two haves, at least. So, I want to see how big a portion of $W$ can be. Therefore, I want $A'\setminus B'$ to have as many supplier as possible.}

Suppose, $|A'\setminus B'|$ is maximised i.e
\begin{align*}
|A'\setminus B'| & = \frac{2}{3}n'\\
& = \frac{2}{3}(s' + |Y \setminus X|) \\
& = \frac{2}{3}s' + \frac{2}{3}|Y \setminus X| \\
& = \frac{2}{3}\frac{c_7}{2}|Y\setminus X| + \frac{2}{3}|Y \setminus X|\\
& = \frac{c_7}{3}|Y \setminus X| + \frac{2}{3}|Y \setminus X|.\\
\end{align*}
Let $s_{A'}$ be the supply generated by the vertices of $A'\setminus B'$, then
$$s_{A'} = \sum_{v\in A'\setminus B'} d(v) = |A'\setminus B'| = \frac{c_7}{3} |Y \setminus X| + \frac{2}{3}|Y \setminus X|$$
At most $\alpha a$ supply unit, my pass through $A'\cap B'$ (by the definition of the congestion at a vertex). \hussein{I think, I have to increase the supply in $A'$ to increase the size of $W_{A'}$}. The remaining supply that are directed towards $W_{A'} = W \cap (A'\setminus B')$ is
$$s_{W_{A'}} = s_{A'} - \alpha a = \frac{c_7}{3} |Y \setminus X| + \frac{2}{3}|Y \setminus X| - \alpha a.$$
The size of $W_{A'}$ is,
\begin{align*}
|W_{A'}| & \leq \frac{s_{W'}}{\alpha}  \\
         & = \frac{(c_7 + 2)}{3 \alpha}|Y \setminus X| - a\\
         & = \frac{(c_7 + 2)}{3 \cdot \frac{c_8 s}{c_1 \cdot c_6 \cdot a}}|Y\setminus X| - a\\
         & = \frac{c_1 \cdot c_6 \cdot (c_7 + 2) \cdot a}{3 \cdot c_8 \cdot c_7 \cdot |Y \setminus X|}|Y \setminus X| - a\\
         & = \frac{c_1 \cdot c_6 \cdot (c_7 + 2)}{3 \cdot c_8 \cdot c_7}a - a\\
\end{align*}
Our goal is to have,
$$|W_{A'}| + |A' \cap B'| + |X \cap Y| \leq |W|.$$
More precisely, \hussein{I think I can replace $c_6$ by $c_6/2$, but that is not important for now.}
$$\frac{c_1 \cdot c_6 \cdot (c_7 + 2)}{3 \cdot c_8 \cdot c_7}a + c_6 \cdot a \leq |W|.$$
\hussein{Now, I want to repeat the same thing but for the small side.}
Let $W_{B'} = W \cap B'$. First, We can go as follow.
\begin{align*}
    |W_{B'}| & \leq |W| - |W_{A'}|\\
    & \leq |W| - \frac{c_1 \cdot c_6 \cdot (c_7 + 2)}{3 \cdot c_8 \cdot c_7}a + a
\end{align*}
This gives as the constraint:
$$|W_{B'}| + |A'\cap B'| + |X\cap Y| \leq |W|,$$
precisely,
$$|W| - \frac{c_1 \cdot c_6 \cdot (c_7 + 2)}{3 \cdot c_8 \cdot c_7}a + a + a + c_6 \cdot a \leq |W|$$
$$ - \frac{c_1 \cdot c_6 \cdot (c_7 + 2)}{3 \cdot c_8 \cdot c_7}a + 2a + c_6 \cdot a \leq 0$$
$$ c_6 \cdot a \leq \frac{c_1 \cdot c_6 \cdot (c_7 + 2)}{3 \cdot c_8 \cdot c_7}a - 2a.$$
\hussein{I hope this make some sense!!!}

Alternatively:\\
We know $A' \setminus B'$ has $s_{A'}$ supplier, then $B'\setminus A'$ has
\begin{align*}
s_{B'} & = s' - s_{A'}  \\
& = \frac{c_7}{2} |Y\setminus X| - \frac{c_7}{3}|Y\setminus X| - \frac{2}{3}|Y \setminus X|\\
& = \frac{3c_7 - 2c_7 - 4}{6}|Y\setminus X|\\
& = \frac{c_7 - 4 }{6} |Y \setminus X|.\\
\end{align*}
\hussein{Here, I might subtract $\alpha a$, but I already did in the previous part, I should be consistent between the two.}
let $$s_{B'} = \frac{c_7 - 4 }{6} |Y \setminus X| - \alpha a$$.
We want to bound $|W_{B'}|$,
\begin{align*}
|W_{B'}| & \leq \frac{s_{B'}}{\alpha}\\
& \leq \frac{c_7 - 4}{6 \alpha}|Y\setminus X| - a\\
& \leq \frac{c_7 - 4}{6 \frac{c_8 \cdot s}{c_1 \cdot c_6 \cdot a}}|Y \setminus X| - a\\
& \leq \frac{c_1 \cdot c_6 \cdot (c_7 - 4) \cdot a}{6 c_8 \cdot c_7 \cdot |Y \setminus X|}|Y\setminus X| - a\\
& \leq \frac{c_1 \cdot c_6 \cdot (c_7 - 4)}{6 c_8 \cdot c_7}\cdot a - a
\end{align*}
Our goal is to have
$$|W_{B'}| + |A' \cap B'| + |X \cap Y| \leq |W|.$$
Precisely,
$$\frac{c_1 \cdot c_6 \cdot (c_7 - 4)}{6 \cdot c_8 \cdot c_7}\cdot a + c_6 \cdot a \leq |W|.$$
\hussein{Now, how the two bounds on $|W_{B'}|$ compares to each other, and do they make sense.}
\hussein{If we plugin some numbers. The two bounds on $W_{A'}$ and $W_{B'}$ will not add up to $W$, I think because the flow decreases, or we are using a smaller flow, less number of vertices in $W$, is going to consume it. (unless there is nothing wrong in my calculation)!}
\subsubsection{$|W|$ and $\alpha$}
We have,
$$|W| \cdot \alpha \geq c_1 \cdot a \frac{c_8 \cdot s}{c_1 \cdot c_6\cdot a} \geq \frac{c_8}{c_6}s.$$
I am obliged to choose $c_8 > c_1$ so it satisfies one of the constraints. But then, $|W| \alpha$ will be higher than $s$.
\hussein{Because of this big difference between $|W| \alpha$ and $s$, the calculation above becomes a bit meaningless.}

% \begin{lem}
%   Let $a\ge 1$, let $G$ be a graph with $\sep(G)\le a$, let $W\subseteq V(G)$, and let $(X,Y)$ be a separation of $G$ such that $W\subseteq Y$ and $|X|/|X\cap Y| > n/(\beta|W|)$.  Then there exists a separation $(A,B)$ of $G$ of order at most $\beta|W|+a$ such that
%   \[
%   \max\{|A\cap W|,|B\cap W|\}\le \left(1-\tfrac{\beta}{3}+\tfrac{\beta^2}{3}\right)|W| \enspace .
%   \]
% \end{lem}

% \begin{proof}
%   Among all separations $(X,Y)$ that satisfy the conditions of the lemma, choose one that maximizes $|X|$.    Let $W':=W\setminus X$.
%   Create a new graph $G'\supseteq G[Y\setminus X]$ as follows:  Let
%   \[
%     n':=n\left(1-\frac{|W\cap X|}{\beta|W|}\right) \enspace .
%   \]
%   Add a set $L$ of $n'-|Y\setminus X|$ degree-$1$ vertices to $G[Y\setminus X]$ adjacent to the vertices in $N_G(X)$, and distributed as equally as possible.  For each $v\in N_G(X)$, let $L_v$ be the subset of $L$ adjacent to $v$.

%   Let
%   \[
%     \beta' = \frac{\beta|W|n'}{|W'|n}
%   \]
%   We will show that $G'$ has a $W'$-cloud with total supply $n'$ and congestion at most $n'/(\beta'|W'|)=n/(\beta|W|)$.  By \cref{flow_vs_cut_n}, it suffices to show that $G'$ has no separation $(X',Y')$ with $W'\subseteq Y'$ and $|X'|/|X'\cap Y'|>n'/(\beta|W'|)$.  Assume for the sake of contradiction that such a separation exists and, among all such separations, choose one that maximizes $|X'|$ and, subject to this, minimizes $|Y'|$.

%   \begin{clm}\label{no_l_in_y}
%     $L\cap Y'=\emptyset$.
%   \end{clm}

%   \begin{clmproof}
%     Let $v$ be a vertex in $N_G(X)$. Since $L=\bigcup_{v\in N_G(X)}L_v$, we need only show that $L_v\cap Y'=\emptyset$.
%     Let $v'$ be an arbitrary vertex in $L_v$.  If $\{v,v'\}\subseteq X'$, then the separation $(X',Y'\setminus\{v'\})$ contradicts the minimality of $Y'$ in the choice of $(X',Y')$.  If $v\in X'$ and $v'\not\in X'$ then the separation $(X'\cup\{v'\},Y'\setminus\{v'\})$ contradicts the maximality of $X'$ in the choice of $(X',Y')$.

%     Thus, $v\not\in X'$.  Let $X'':=X'\setminus L_v$, consider the separation $(X'',Y')$ and observe that
%     \[
%       \frac{X''}{|X''\cap Y'|}=\frac{|X'\setminus L_v|}{|(X'\setminus L_v)\cap Y'|}
%      = \frac{|X'|-|X'\cap L_v|}{|X'\cap Y'|-|X'\cap L_v|} > \frac{n'}{\beta|W'|}
%     \]
%     since $(a-x)/(b-x) \ge a/c$ for any $a,b,x$ with $0\le x<b<a$.  Then the separation $(X''',Y'''):=(X''\cup L_v\cup \{v\},Y'\setminus L_v)$ satisfies
%     \[
%       \frac{|X'''|}{|X'''\cap Y'''|} =
%       \frac{|X''\cup L_v\cup \{v\}|}{|(X''\cup L_v\cup\{v\})\cap (Y'\setminus L_v)|} = \frac{|X''|+n'/(\beta|W'|)+1}{|X''\cap Y'|+1} > \frac{n'}{\beta|W'|}
%     \]
%     since $(a+m)/(b+1)\ge m$ for any $m>0$ and any $a,b>0$ such that $a/b\ge m$.  Therefore, the separation $(X''',Y''')$ contradicts the maximality of $|X'|$ in the choice of $(X',Y')$.
%   \end{clmproof}

%   \begin{clm}
%     $N_G(X)\subseteq X'$.
%   \end{clm}

%   \begin{clmproof}
%     It must be the case that $N_{G'}[L]\subseteq X'$ since, otherwise, there would be an edge $vv'$ of $G'$ with $v\in N_{G'}(L)$ and $v'\in L$ such that $\{v,v'\}\not\subseteq X'$ and $\{v,v'\}\not\subseteq Y'$.  This would contradict the fact that $(X',Y')$ is a separation of $G$.
%     Therefore $N_G(X)\subseteq N_{G'}(L)\subseteq X'$.
%   \end{clmproof}

%   Let
%   \[
%     \widehat{X}:=X\cup X'\setminus L \text{ and let } \widehat{Y}:=Y'\cup W \enspace .
%   \]
%   \begin{clm}
%     $(\widehat{X},\widehat{Y})$ is a separation of $G$.
%   \end{clm}

%   \begin{clmproof}
%     We first show that $\widehat{X}\cup\widehat{Y}\subseteq V(G)$.
%     The vertices in $\widehat{X}\cup\widehat{Y}$ are contained $X\cup V(G')\subseteq V(G)\cup L$.
%     By definition $L\cap \widehat{X}=\emptyset$. By \cref{no_l_in_y}, $L\cap \widehat{X}=\emptyset$. Thus $\widehat{X}\cup\widehat{Y}\subseteq V(G)$.
%     Next we show that $\widehat{X}\cup\widehat{Y}\supseteq V(G)$.  Since $X\cup Y=V(G)$, each vertx of $G$ is in $X$ or is in $Y\setminus X$.
%     For each $v\in X$, $v\in \widehat{X}$.  For each $v\in Y\setminus X$,
%     \begin{enumerate*}[label=(\alph*)]
%       \item $v\in X'$, in which case $v\in \widehat{X}$;
%       or \item $v\in Y'$ in which case $v\in\widehat{Y}$.
%     \end{enumerate*}
%     Thus $V(G)\subseteq \widehat{X}\cup\widehat{Y}\subseteq V(G)$, so $\widehat{X}\cup\widehat{Y}= V(G)$.

%     What remains is to verify that for each edge $vw$ of $G$, $\{v,w\}\subseteq \widehat{X}$ or $\{v,w\}\subseteq\widehat{Y}$.
%     Without loss of generality (at least) one of the following applies:
%     \begin{enumerate}[nosep,nolistsep,label=(\roman*)]
%       % \item $v\in X\cap W$: In this case $v\in\widehat{X}$ and $v\in\widehat{Y}$.
%       \item $v\in X$: In this case $v\in\widehat{X}$ and $w\in N_G[X]\subseteq\widehat{X}$.
%       \item $v\in N_G(X)$: In this case $w\in X$ or $w\in Y\setminus X$.  In the former case $v\in N_G(X)\subseteq X$ and $w\in X\subseteq \widehat{X}$. In the latter case $v,w\in Y\setminus X$.  Since $(X',Y')$ is a separation of $G'\supseteq G[Y\setminus X]$, either $v,w\in X'\subseteq \widehat{X}$ or $v,w\in Y'\subseteq\widehat{Y}$. \qedhere
%     \end{enumerate}
%   \end{clmproof}

%   Next we show that $(\widehat{X},\widehat{Y})$ contradicts the maximality of $X$ in the choice of $(X,Y)$.

%   \begin{clm}
%     $|\widehat{X}|/|\widehat{X}\cap\widehat{Y}|>n/(\beta|W|)$.
%   \end{clm}

%   \begin{clmproof}
%     Since $Y'\subseteq Y\setminus X$, $X\cap \hat{Y}=X\cap W$. Since $X'\subseteq Y\setminus X$,
%     \[
%       X'\cap \widehat{Y}=X'\cap (Y'\cup W)=X'\cap (Y'\cup (W\cap X))=X'\cap Y' \enspace .
%     \]
%     Therefore, $|\widehat{X}\cap\widehat{Y}|=|X'\cap Y'|+|X\cap W|$.
%     On the other hand,
%     \begin{align*}
%       |\widehat{X}|
%         & = |X| + |X'| - |L| \\
%         & = |X| + |X'| - (n'-|Y\setminus X|) \\
%         & = |X| + |X'| - (n'-(n-|X|)) \\
%         & = |X'| - (n'-n)) \\
%         & = |X'| + \frac{|W\cap X|n}{\beta|W|} \\
%     \end{align*}
%     Now recall that
%     \begin{align*}
%       \frac{|X'|}{|X'\cap Y'|}
%         & >  \frac{n'}{\beta'|W'|} = \frac{n}{\beta|W|} \enspace .
%     \end{align*}


%     Therefore,
%     \begin{align*}
%       \frac{|\widehat{X}|}{|\widehat{X}\cap\widehat{Y}|}
%         & = \frac{|X'| + \frac{|W\cap X|n}{\beta|W|}}{|X'\cap Y'|+|X\cap W|}  \\
%         & > \frac{n}{\beta|W|} \qedhere
%     \end{align*}
%   \end{clmproof}
%   Since $|\widehat{X}|>|X|$, this contradicts the maximality of $|X|$ in the choice of $(X,Y)$

%   Thus $G'$ has a $W'$-cloud with total supply $n'$ and congestion at most $n'/(\beta'|W|)=n/(\beta|W|)$.  Let $(A',B')$ be a balanced separation of $G[X\setminus Y]$ of order at most $a$.  For each vertex $v\in V(G')\setminus V(G)$, add $v$ to $A'$ if the unique neighbour of $v$ is in $A'$, otherwise add $v$ to $B'$.  This gives separation of $G'$ whose order is at most $a$.  \textcolor{red}{[There's a big problem here.  We can't be sure that the resulting separation is a balanced separation of $G'$! This means we can't apply \cref{balanced_on_w}]}  By \cref{balanced_on_w}, $|A'\cap W\setminus X|\le (1-\tfrac{\beta'}{3})|W\setminus X|+2a$ and $|B'\cap W\setminus X|\le (1-\tfrac{\beta'}{3})|W\setminus X|+2a$.

%   Finally, let $A:=X\cup A'\cap V(G)$ and let $B:=(X\cap Y)\cup B'\cap V(G)$.  Then $(A,B)$ is a separation of $G$ with
%   \[
%     |A\cap B|\le |X\cap Y|+|A'\cap B'| \le \beta|W| + a
%   \]
%   Furthermore,
%   \begin{align*}
%     |A\cap W| & \le |X\cap W|+(1-\tfrac{\beta'}{3})|W\setminus X| \\
%        & = |X\cap W|+(1-\tfrac{\beta'}{3})(|W|-|W\cap X|) \\
%        & = \tfrac{\beta'}{3}|X\cap W|+(1-\tfrac{\beta}{3})|W| \\
%        & \le \tfrac{\beta\beta'}{3}|W|+(1-\tfrac{\beta'}{3})|W| \\
%        & = (1-\tfrac{\beta}{3}+\tfrac{\beta\beta'}{3})|W|
%   \end{align*}
% \end{proof}



\bibliographystyle{plainurlnat}
\bibliography{dnr}


\end{document}
